<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PER & PIE | Gestión Completa (Corregido)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Agregado: Librería para generar la imagen de la etiqueta -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --background-color: #f3f4f6;
            --text-color: #1f2937;
            --card-background: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .main-container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: var(--card-background); padding: 1.5rem; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; transition: transform 0.3s ease-in-out; transform: translateX(0); z-index: 40; position: fixed; top: 0; left: 0; height: 100%; }
        .content { flex-grow: 1; padding: 2rem; overflow-y: auto; margin-left: 250px; }
        .view { display: none; }
        .view.active { display: block; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover, .sidebar-link.active { background-color: var(--primary-color); color: white; }
        .sidebar-link i { width: 20px; margin-right: 0.75rem; }
        .card { background-color: var(--card-background); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .notification-badge { background-color: #ef4444; color: white; border-radius: 50%; padding: 0.1rem 0.4rem; font-size: 0.7rem; margin-left: auto; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 500; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 0.5rem; transform: translateX(120%); opacity: 0; transition: all 0.4s ease; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { background-color: var(--secondary-color); }
        .toast.error { background-color: #ef4444; }
        #loading-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background-color: var(--primary-color); opacity: 0; transition: opacity 0.3s; z-index: 200; transform-origin: left; animation: loading-animation 1.5s infinite; }
        @keyframes loading-animation { 0% { transform: scaleX(0); } 50% { transform: scaleX(0.7); } 100% { transform: scaleX(0); } }
        .combo-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        #menu-toggle-btn { display: none; }
        
        .adaptive-text, .adaptive-text-large {
            word-break: break-word;
            line-height: 1.1;
            overflow-wrap: break-word;
        }
        .adaptive-text-large { font-size: clamp(1.875rem, 5vw, 2.25rem); }
        .adaptive-text { font-size: clamp(1.5rem, 4vw, 1.875rem); }
        #special-qr-code-container img, #special-qr-code-container canvas { margin: auto; }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { transform: translateX(-100%); width: 100%; }
            .sidebar.active { transform: translateX(0); }
            .content { padding: 1rem; margin-left: 0; width: 100%; }
            /* MEJORA SOLICITADA: Botón de menú a la derecha */
            #menu-toggle-btn { 
                display: block; 
                position: fixed; 
                top: 1rem; 
                right: 1rem; /* Cambiado de left a right */
                z-index: 50; 
            }
        }
    
        /* === OVERRIDES: paleta solicitada por el usuario === */
        .btn-primary { background-color: #007bff !important; color: white !important; }
        .btn-primary:hover:not(:disabled) { background-color: #0069d9 !important; }
        .btn-whatsapp { background-color: #28a745 !important; color: white !important; }
        .btn-whatsapp:hover { background-color: #218838 !important; }
        .btn-danger { background-color: #dc3545 !important; color: white !important; }
        .btn-danger:hover { background-color: #c82333 !important; }
        .btn-discount { background-color: #ffc107 !important; color: black !important; }
        .btn-discount:hover { background-color: #e0a800 !important; }
        .btn-secondary, .btn-dismiss { background-color: #ff69b4 !important; color: white !important; }
        .btn-secondary:hover, .btn-dismiss:hover { background-color: #ff4da6 !important; }
        /* Nuevo botón para imagen */
        .btn-image { background-color: #800080 !important; color: white !important; }
        .btn-image:hover { background-color: #6a006a !important; }
        
        /* SOLUCIÓN 1: Estilos para botones de ajuste de stock */
        .stock-adjust-btn {
            background-color: #f3f4f6; /* gris muy claro */
            color: #4b5563; /* gris oscuro */
            border: 1px solid #d1d5db; /* borde gris */
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding-bottom: 2px; /* Alineación vertical del símbolo */
        }
        .stock-adjust-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stock-adjust-btn.minus:hover {
            background-color: #fee2e2; /* rojo claro */
            color: #b91c1c; /* rojo oscuro */
            border-color: #fca5a5;
        }
        .stock-adjust-btn.plus:hover {
            background-color: #dcfce7; /* verde claro */
            color: #15803d; /* verde oscuro */
            border-color: #86efac;
        }

        /* === ESTILOS EFEMÉRIDES === */
        .event-highlight-proximo { background-color: #fffbeb; color: #b45309; font-weight: 600; }
        .event-status-pasado { color: #9ca3af; }
        .event-status-proximo { color: #059669; font-weight: bold; }
        .event-status-hoy { background-color: #10b981; color: white; padding: 0.2rem 0.5rem; border-radius: 9999px; font-size: 0.8rem; font-weight: bold; }
        .notification-card { background-color: white; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; gap: 0.75rem; width: 100%; max-width: 400px; }
        .notification-card-header { font-size: 1.125rem; font-weight: 600; color: #1f2937; }
        .notification-card-body { font-size: 0.875rem; color: #4b5563; }
        .notification-card-footer { display: flex; gap: 0.75rem; margin-top: 0.5rem; }
        .notification-card-footer .btn, .notification-card-footer a.btn { flex-grow: 1; padding: 0.5rem 1rem; font-size: 0.875rem; text-align: center; }
    
        /* --- INICIO: ESTILOS PARA EL GENERADOR DE ETIQUETAS --- */
        #label-generator-modal .modal-content {
            max-width: 400px; /* Ajustar ancho del modal */
            padding: 1rem;
        }

        /* MEJORA 3: Se asegura el centrado vertical y horizontal de la tarjeta en el lienzo de captura. */
        #etiqueta-area-captura-final {
            width: 340px; 
            height: 620px; 
            margin: 10px auto; 
            padding: 10px 5px; 
            background-color: #f3f4f6; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #etiqueta-visor-promo {
            width: 320px; 
            height: 600px; 
            position: relative; 
            background-color: white; 
            border-radius: 40px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
            overflow: hidden;
            border: 1px solid #ddd; 
            margin: 0; 
        }

        #etiqueta-visor-promo::after {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            background: linear-gradient(to bottom right, #FFD700, #FF66B2, #800080);
            border-radius: 35px; z-index: 1; pointer-events: none;
        }
        #etiqueta-visor-promo::before {
            content: ''; position: absolute; top: 14px; left: 14px; right: 14px; bottom: 14px;
            background-color: white; border-radius: 30px; z-index: 2; pointer-events: none;
        }

        #etiqueta-brand-text {
            position: absolute; top: 25px; width: 100%; text-align: center;
            font-size: 1.1em; font-weight: 900; z-index: 3; margin-bottom: 5px; color: #FFD700; 
        }

        #etiqueta-contact-numbers {
            position: absolute; top: 45px; width: 100%; text-align: center;
            font-size: 0.9em; font-weight: 600; z-index: 3; color: #800080; 
        }
        
        #etiqueta-visor-contenido {
            position: relative; z-index: 3; padding: 85px 35px 15px 35px; 
            display: flex; flex-direction: column; align-items: center; 
            height: 100%; justify-content: flex-start; text-align: center;
        }
        
        #etiqueta-contenedor-imagen {
            width: 100%; max-height: 240px; min-height: 180px;
            flex-grow: 1; overflow: hidden; display: flex;
            align-items: center; justify-content: center; 
            margin-bottom: 5px; border-radius: 8px; background-color: white; 
        }
        #etiqueta-visor-imagen {
            max-width: 100%; width: auto; height: 100%; 
            object-fit: contain; display: block;
        }
        
        #etiqueta-text-block {
            width: 100%; padding: 0; display: flex;
            flex-direction: column; align-items: center; margin-top: 0;
            flex-shrink: 1; /* Permite que el bloque de texto se encoja si es necesario */
            min-height: 0; /* Necesario para que flex-shrink funcione correctamente en un contenedor flex */
        }

        /* INICIO: Corrección del error de superposición */
        /* SOLUCIÓN: Se ajusta el título para que se divida en varias líneas si es necesario, evitando la superposición con el precio. */
        #etiqueta-promo-title {
            margin: 0 0 8px 0; /* Añade un margen inferior para separar claramente del precio */
            font-size: 1.2em;
            font-weight: 900;
            color: #333;
            white-space: normal; /* Permite que el texto se divida en múltiples líneas */
            word-wrap: break-word; /* Asegura que palabras largas no se desborden */
            line-height: 1.2;
            max-width: 100%;
        }
        
        /* Se ajusta el margen del precio para mantener consistencia visual con el nuevo espaciado del título. */
        #etiqueta-promo-price {
            margin: 0 0 12px 0; /* Se ajusta el margen superior a 0 y se mantiene un margen inferior generoso */
            font-size: 2.5rem;
            line-height: 1.1;
            font-weight: 900;
            letter-spacing: -1px;
            width: 100%;
            padding: 0 5px;
            color: #FFD700;
        }
        /* FIN: Corrección del error de superposición */

        #etiqueta-promo-description { margin: 0 0 5px 0; font-size: 1.1em; line-height: 1.4; font-weight: 500; color: #555; }
        
        /* MEJORA 2: Se quita la altura máxima para que la lista de productos crezca según su contenido. */
        #etiqueta-promo-list { 
            list-style: none;
            margin: 15px 0 0 0; 
            padding: 0 0 20px 0;
            text-align: left; width: 100%; max-width: 300px;
        }
        #etiqueta-promo-list li { 
            font-size: 1em; line-height: 1.4; margin-bottom: 5px;
            color: #333;
        }
        #etiqueta-promo-list li span { color: #333; font-weight: 500; }
        /* --- FIN: ESTILOS PARA EL GENERADOR DE ETIQUETAS --- */

        /* INICIO: MEJORAS SOLICITADAS */
        #combo-item-selector optgroup {
            font-size: 0.9em;
            font-weight: bold;
            color: #dc3545; /* Color rojo (btn-danger) */
            padding: 5px 2px;
            font-style: normal;
        }
        /* FIN: MEJORAS SOLICITADAS */

    </style>
</head>
<body class="bg-gray-100">

    <button id="menu-toggle-btn" class="btn btn-primary px-3 py-2 rounded-lg text-white"><i class="fas fa-bars"></i></button>

    <div id="loading-indicator"></div>
    <div id="toast-container"></div>
    
    <div id="generic-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="modal-body" class="mb-6"></div>
            <div id="modal-footer" class="flex justify-end gap-4"></div>
        </div>
    </div>
    
    <!-- INICIO: Modal para el Generador de Etiquetas -->
    <div id="label-generator-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-center">Etiqueta para Redes Sociales</h3>
            
            <div id="etiqueta-area-captura-final">
                <div id="etiqueta-visor-promo">
                    <div id="etiqueta-brand-text">PER & PIE Bebidas</div>
                    <div id="etiqueta-contact-numbers">342 5993971 / 3483 483892</div>
                    <div id="etiqueta-visor-contenido">
                        <div id="etiqueta-contenedor-imagen">
                            <img id="etiqueta-visor-imagen" src="" alt="Vista previa del combo">
                        </div>
                        <div id="etiqueta-text-block">
                            <h3 id="etiqueta-promo-title"></h3>
                            <h2 id="etiqueta-promo-price"></h2>
                            <p id="etiqueta-promo-description"></p> 
                            <ul id="etiqueta-promo-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-4 mt-4">
                <button onclick="app.closeLabelGenerator()" class="btn bg-gray-300 hover:bg-gray-400">Cerrar</button>
                <button onclick="app.downloadLabelAsPNG()" class="btn btn-primary"><i class="fas fa-download mr-2"></i>Descargar PNG</button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal para el Generador de Etiquetas -->

    <div class="main-container">
        <aside class="sidebar" id="sidebar">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                <span class="text-blue-600">PER</span> & <span class="text-pink-600">PIE</span>
            </h1>
            <p class="text-sm font-semibold text-gray-500 mb-4">Bebidas | Gestión Completa</p>
            <nav id="sidebar-nav" class="flex flex-col space-y-1">
                <a class="sidebar-link active" data-view="dashboard"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
                <hr class="my-2 border-gray-200">
                <a class="sidebar-link" data-view="productos"><i class="fas fa-box"></i><span>Productos</span></a>
                <a class="sidebar-link" data-view="stock"><i class="fas fa-warehouse"></i><span>Stock</span><span id="low-stock-badge" class="notification-badge hidden"></span></a>
                <a class="sidebar-link" data-view="promociones"><i class="fas fa-tags"></i><span>Combos</span></a>
                <hr class="my-2 border-gray-200">
                <a class="sidebar-link" data-view="clientes"><i class="fas fa-users"></i><span>Clientes</span></a>
                <a class="sidebar-link" data-view="ventas"><i class="fas fa-cash-register"></i><span>Ventas</span></a>
                <a class="sidebar-link" data-view="gastos"><i class="fas fa-file-invoice-dollar"></i><span>Gastos/Insumos</span></a>
                <a class="sidebar-link" data-view="reportes"><i class="fas fa-chart-pie"></i><span>Reportes</span></a>
                <hr class="my-2 border-gray-200">
                <a class="sidebar-link" data-view="descuentos"><i class="fas fa-percent"></i><span>Descuentos</span></a>
                <a class="sidebar-link" data-view="efemerides"><i class="fas fa-calendar-alt"></i><span>Feriados/Efemérides</span></a>
                <a class="sidebar-link" data-view="configuracion"><i class="fas fa-cogs"></i><span>Configuración</span></a>
            </nav>
            <div class="mt-auto pt-8">
                 <a id="instagram-link" href="#" target="_blank" class="sidebar-link bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white">
                    <i class="fab fa-instagram"></i><span>Mi Instagram</span>
                </a>
            </div>
        </aside>

        <main class="content">
            
            <div id="dashboard" class="view active">
                 <!-- Contenido del Dashboard sin cambios -->
                <div class="text-center my-8 md:my-16">
                    <h1 class="text-6xl md:text-8xl font-bold tracking-tight">
                        <span class="text-blue-600">PER</span> & <span class="text-pink-600">PIE</span>
                    </h1>
                    <p class="text-3xl md:text-4xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-pink-600 mt-2">
                        Bebidas
                    </p>
                </div>
                
                <h3 class="text-2xl font-bold mt-8 mb-4 border-b pb-2">Métricas de HOY</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                    <div class="card bg-green-600 text-white"><h3 class="text-xl font-semibold mb-2">Mi Pago Hoy</h3><p id="dashboard-mi-pago-hoy" class="font-bold adaptive-text-large">$0.00</p></div>
                    <div class="card bg-blue-600 text-white"><h3 class="text-xl font-semibold mb-2">Ganancia Hoy</h3><p id="dashboard-ganancia-hoy" class="font-bold adaptive-text-large">$0.00</p></div>
                    <div class="card bg-yellow-600 text-white"><h3 class="text-xl font-semibold mb-2">Ventas Hoy</h3><p id="dashboard-ventas-hoy" class="font-bold adaptive-text-large">$0.00</p></div>
                </div>
            
                <h3 class="text-2xl font-bold mt-4 mb-4 border-b pb-2 text-teal-600">Mi Pago por Período</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-teal-600">Semanal</h4><p id="dashboard-mi-pago-semanal" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-teal-600">Quincenal</h4><p id="dashboard-mi-pago-quincenal" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-teal-600">Mensual</h4><p id="dashboard-mi-pago-mensual" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-teal-600">Anual</h4><p id="dashboard-mi-pago-anual" class="font-bold adaptive-text">$0.00</p></div>
                </div>
            
                <h3 class="text-2xl font-bold mt-4 mb-4 border-b pb-2 text-blue-600">Ganancias por Período</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-blue-600">Semanal</h4><p id="dashboard-ganancia-semanal" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-blue-600">Quincenal</h4><p id="dashboard-ganancia-quincenal" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-blue-600">Mensual</h4><p id="dashboard-ganancia-mensual" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-blue-600">Anual</h4><p id="dashboard-ganancia-anual" class="font-bold adaptive-text">$0.00</p></div>
                </div>
            
                <h3 class="text-2xl font-bold mt-4 mb-4 border-b pb-2 text-yellow-600">Ventas por Período</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-yellow-600">Semanal</h4><p id="dashboard-ventas-semanal" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-yellow-600">Quincenal</h4><p id="dashboard-ventas-quincenal" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-yellow-600">Mensual</h4><p id="dashboard-ventas-mensual" class="font-bold adaptive-text">$0.00</p></div>
                    <div class="card"><h4 class="text-lg font-semibold mb-1 text-yellow-600">Anual</h4><p id="dashboard-ventas-anual" class="font-bold adaptive-text">$0.00</p></div>
                </div>
            </div>

            <div id="productos" class="view">
                 <!-- Contenido de Productos sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Gestionar Productos</h2>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4" id="producto-form-title">Cargar Nuevo Artículo</h3>
                    <form id="form-producto" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="producto-id">
                        <div><label for="producto-nombre" class="block mb-2 font-medium">Nombre del Artículo</label><input type="text" id="producto-nombre" class="form-input" required></div>
                        <div>
                            <label for="producto-categoria" class="block mb-2 font-medium">Categoría</label>
                            <select id="producto-categoria" class="form-input" required>
                                <option value="">Seleccione una categoría</option>
                                <option value="Vinos">Vinos</option>
                                <option value="Fernet">Fernet</option>
                                <option value="Aperitivos">Aperitivos</option>
                                <option value="Cervezas">Cervezas</option>
                                <option value="Gaseosas y Aguas">Gaseosas y Aguas</option>
                                <option value="Licores y Destilados">Licores y Destilados</option>
                                <option value="Espumantes">Espumantes</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div><label for="producto-stock" class="block mb-2 font-medium">Stock Inicial/Actual</label><input type="number" id="producto-stock" class="form-input" required min="0"></div>
                        
                        <div><label for="producto-costo" class="block mb-2 font-medium">Precio de Costo ($)</label><input type="number" id="producto-costo" class="form-input" step="any" required min="0"></div>

                        <div class="md:col-span-2">
                            <hr class="my-3">
                            <div class="mb-2">
                              <label class="block text-sm font-medium text-gray-700">Calcular desde caja (opcional)</label>
                              
                              <div class="flex gap-2 mt-1">
                                <input type="number" step="0.01" id="precioCaja" class="form-input w-1/2" placeholder="Precio caja">
                                <input type="number" id="unidadesCaja" class="form-input w-1/2" placeholder="Unidades por caja">
                              </div>

                              <button type="button" onclick="calcularCostoUnitario()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">
                                Calcular costo unitario
                              </button>

                              <p id="resultadoCosto" class="mt-2 text-green-700 font-semibold"></p>
                            </div>
                        </div>

                        <div class="md:col-span-2"><label for="producto-imagen" class="block mb-2 font-medium">Imagen del Producto</label><input type="file" id="producto-imagen" class="form-input" accept="image/*"><img id="productImagePreview" src="https://placehold.co/150x150/e2e8f0/adb5bd?text=Imagen" alt="Vista previa" class="mt-4 rounded-md object-cover max-w-[150px] max-h-[150px]"></div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border rounded-lg bg-gray-50">
                            <div><label for="producto-porcentaje1" class="block mb-2 font-medium text-blue-600">Porcentaje Precio 1 (%)</label><input type="number" id="producto-porcentaje1" class="form-input" step="any" min="0" value="30"><p class="text-sm mt-2">Precio Venta: <span id="preview-precio1" class="font-bold">--</span></p><p class="text-sm">Ganancia: <span id="preview-ganancia1" class="font-bold text-green-600">--</span></p></div>
                            <div><label for="producto-porcentaje2" class="block mb-2 font-medium text-purple-600">Porcentaje Precio 2 (%)</label><input type="number" id="producto-porcentaje2" class="form-input" step="any" min="0" value="50"><p class="text-sm mt-2">Precio Venta: <span id="preview-precio2" class="font-bold">--</span></p><p class="text-sm">Ganancia: <span id="preview-ganancia2" class="font-bold text-green-600">--</span></p></div>
                        </div>
                        <div class="md:col-span-2"><p class="text-sm font-medium">Mi Pago (de ganancia precio 1): <span id="preview-pago" class="font-bold text-teal-600">--</span></p></div>
                        <div class="md:col-span-2 flex justify-end gap-4"><button type="button" id="btn-cancelar-edicion" class="btn bg-gray-300 hover:bg-gray-400 hidden">Cancelar</button><button type="submit" id="btn-guardar-producto" class="btn btn-primary">Guardar Producto</button></div>
                    </form>
                </div>
            </div>
            
            <div id="stock" class="view">
                 <!-- Contenido de Stock sin cambios -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Control de Stock</h2>
                    <button id="btn-generate-pdf" class="btn btn-secondary">
                        <i class="fas fa-file-pdf mr-2"></i>Generar Lista de Precios
                    </button>
                </div>
                <div class="card overflow-x-auto">
                    <table class="w-full text-left">
                        <thead><tr class="border-b"><th class="p-4">Imagen</th><th class="p-4">Producto</th><th class="p-4">Categoría</th><th class="p-4">Stock</th><th class="p-4">Precio Costo</th><th class="p-4">Precio Venta 1</th><th class="p-4">Precio Venta 2</th><th class="p-4">Acciones</th></tr></thead>
                        <tbody id="tabla-stock"></tbody>
                    </table>
                </div>
            </div>

            <div id="promociones" class="view">
                <h2 class="text-3xl font-bold mb-6">Crear y Gestionar Combos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card lg:col-span-1">
                        <h3 class="text-xl font-semibold mb-4" id="combo-form-title">Cargar Nuevo Combo</h3>
                        <form id="form-combo" class="space-y-4">
                            <input type="hidden" id="combo-id">
                            <div><label for="combo-nombre" class="block mb-1 font-medium">Nombre del Combo</label><input type="text" id="combo-nombre" class="form-input" required></div>
                            <div>
                                <label class="block mb-1 font-medium">Items del Combo</label>
                                <div class="grid grid-cols-2 gap-2 p-2 border rounded-lg bg-gray-50">
                                    <div>
                                        <label for="combo-item-tipo" class="text-xs font-medium">Tipo</label>
                                        <select id="combo-item-tipo" class="form-input text-sm">
                                            <option value="Producto">Producto</option>
                                            <option value="Insumo">Insumo</option>
                                        </select>
                                    </div>
                                    <div>
                                         <label for="combo-item-selector" class="text-xs font-medium">Item</label>
                                         <select id="combo-item-selector" class="form-input text-sm"></select>
                                    </div>
                                    <div class="col-span-2 flex items-end gap-2">
                                        <div class="flex-grow">
                                            <label for="combo-item-cantidad" class="text-xs font-medium">Cantidad</label>
                                            <input type="number" id="combo-item-cantidad" class="form-input text-sm" placeholder="Ej: 1 o 0.25" min="0.01" step="0.01" value="1">
                                        </div>
                                        <button type="button" id="btn-agregar-item-combo" class="btn btn-secondary h-[42px] text-sm px-4 py-2" title="Agregar">+</button>
                                    </div>
                                </div>
                                <div id="combo-items-list" class="mt-2 space-y-2"></div>
                            </div>
                            <div><label for="combo-precio" class="block mb-1 font-medium">Precio de Venta ($)</label><input type="number" id="combo-precio" class="form-input" step="any" required min="0"></div>
                            <div class="p-2 border rounded-lg bg-gray-50 text-sm space-y-1">
                                <p>Costo del Combo: <span id="combo-costo-preview" class="font-bold text-red-600">$ 0,00</span></p>
                                <p>Referencia Descuento ($): <span id="combo-descuento-referencia" class="font-bold text-yellow-600">$ 0,00</span></p>
                                <p>Ganancia Estimada: <span id="combo-ganancia-preview" class="font-bold text-green-600">$ 0,00</span></p>
                                <p>Mi Pago Estimado: <span id="combo-pago-preview" class="font-bold text-teal-600">$ 0,00</span></p>
                            </div>
                            <div class="flex items-center pt-2">
                                <input type="checkbox" id="combo-descuento-aplicable" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="combo-descuento-aplicable" class="ml-2 block text-sm font-medium text-gray-700">Permitir aplicar descuentos a este combo</label>
                            </div>
                            <div><label for="combo-imagen" class="block mb-1 font-medium">Imagen del Combo</label><input type="file" id="combo-imagen" class="form-input" accept="image/*"><img id="comboImagePreview" src="https://placehold.co/150x150/e2e8f0/adb5bd?text=Imagen" alt="Vista previa" class="mt-4 rounded-md object-cover max-w-[150px] max-h-[150px]"></div>
                            <div class="flex justify-end gap-4 pt-2"><button type="button" id="btn-cancelar-combo" class="btn bg-gray-300 hover:bg-gray-400 hidden">Cancelar</button><button type="submit" id="btn-guardar-combo" class="btn btn-primary">Guardar Combo</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4">Combos Guardados</h3>
                            <div id="lista-combos" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-[75vh] overflow-y-auto p-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="clientes" class="view">
                 <!-- Contenido de Clientes sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Gestión de Clientes</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card lg:col-span-1">
                        <h3 class="text-xl font-semibold mb-4" id="cliente-form-title">Cargar Nuevo Cliente</h3>
                        <form id="form-cliente" class="space-y-4">
                            <input type="hidden" id="cliente-id">
                            <div><label for="cliente-nombre" class="block mb-1 font-medium">Nombre y Apellido</label><input type="text" id="cliente-nombre" class="form-input" required></div>
                            <div><label for="cliente-telefono" class="block mb-1 font-medium">Teléfono (WhatsApp)</label><input type="text" id="cliente-telefono" class="form-input"></div>
                            <div><label for="cliente-fecha-nacimiento" class="block mb-1 font-medium">Fecha de Nacimiento</label><input type="date" id="cliente-fecha-nacimiento" class="form-input"></div>
                            <div><label for="cliente-direccion" class="block mb-1 font-medium">Dirección</label><input type="text" id="cliente-direccion" class="form-input"></div>
                            <div class="flex justify-end gap-4 pt-2"><button type="button" id="btn-cancelar-cliente" class="btn bg-gray-300 hover:bg-gray-400 hidden">Cancelar</button><button type="submit" id="btn-guardar-cliente" class="btn btn-primary">Guardar Cliente</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4">Lista de Clientes</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="p-4">Nombre</th>
                                            <th class="p-4">Teléfono</th>
                                            <th class="p-4">Fecha de Nac.</th>
                                            <th class="p-4">Dirección</th>
                                            <th class="p-4">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-clientes"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ventas" class="view">
                 <!-- Contenido de Ventas sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Registro de Ventas</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card">
                        <h3 class="text-xl font-semibold mb-4">Carrito de Venta</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-4 items-end p-2 border rounded-lg bg-gray-50">
                            <div class="md:col-span-3">
                                <label for="venta-tipo-item" class="text-sm font-medium">Tipo</label>
                                <select id="venta-tipo-item" class="form-input">
                                    <option value="productos">Productos</option>
                                    <option value="combos">Combos</option>
                                </select>
                            </div>
                            <div class="md:col-span-5">
                                <label for="venta-item-selector" class="text-sm font-medium">Artículo</label>
                                <select id="venta-item-selector" class="form-input w-full"><option value="">Seleccione...</option></select>
                            </div>
                            <div class="md:col-span-2" id="venta-precio-container">
                                <label for="venta-precio-selector" class="text-sm font-medium">Precio</label>
                                <select id="venta-precio-selector" class="form-input">
                                    <option value="1">Precio 1</option>
                                    <option value="2">Precio 2</option>
                                </select>
                            </div>
                            <div class="md:col-span-1">
                                <label for="venta-item-cantidad" class="text-sm font-medium">Cant.</label>
                                <input type="number" id="venta-item-cantidad" class="form-input w-full text-center" min="1" value="1">
                            </div>
                            <div class="md:col-span-1">
                                 <button type="button" id="btn-agregar-item-venta" class="btn btn-secondary w-full h-full flex items-center justify-center" title="Agregar al carrito"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto min-h-[200px]"><table class="w-full text-left mb-4"><thead><tr class="border-b"><th class="p-2">Item</th><th class="p-2">Precio Unit.</th><th class="p-2">Cant.</th><th class="p-2">Total</th><th class="p-2">Acciones</th></tr></thead><tbody id="tabla-carrito"></tbody></table></div>
                    </div>
                    
                    <div class="lg:col-span-1 card">
                        <h3 class="text-xl font-semibold mb-4">Resumen y Pago</h3>
                        <form id="form-venta" class="space-y-4">
                            <div><label for="venta-cliente" class="block mb-1 font-medium">Cliente (Opcional)</label><select id="venta-cliente" class="form-input"></select></div>
                            <div><label for="venta-descuento-selector" class="block mb-1 font-medium">Descuento Aplicado</label><select id="venta-descuento-selector" class="form-input"></select></div>
                            <div>
                                <label for="venta-forma-pago" class="block mb-1 font-medium">Forma de Pago</label>
                                <select id="venta-forma-pago" class="form-input" required>
                                    <option value="Contado">Contado</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Pendiente de Pago (Fiado)">Pendiente de Pago (Fiado)</option>
                                    <option value="Tarjeta de Debito">Tarjeta de Debito</option>
                                </select>
                            </div>
                            <div class="text-2xl font-bold border-t pt-4">Subtotal: <span id="venta-subtotal" class="float-right">$0.00</span></div>
                            <div class="text-xl font-semibold text-red-600">Descuento: <span id="venta-monto-descuento" class="float-right">$0.00</span></div>
                            <div class="text-3xl font-bold text-green-600 border-t pt-4">TOTAL: <span id="venta-total" class="float-right">$0.00</span></div>
                            <div class="flex justify-end pt-4 gap-2">
                                <button type="button" id="btn-limpiar-venta-completa" class="btn bg-gray-300 hover:bg-gray-400">Limpiar</button>
                                <button type="submit" id="btn-guardar-venta" class="btn btn-primary flex-grow" disabled>Registrar Venta</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="gastos" class="view">
                 <!-- Contenido de Gastos sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Registro de Gastos e Insumos</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card bg-red-100"><h3 class="text-lg font-semibold mb-1 text-red-700">Gastos Mensuales (del mes actual)</h3><p id="gastos-mensual-total" class="text-3xl font-bold text-red-800">$0.00</p></div>
                    <div class="card bg-red-100"><h3 class="text-lg font-semibold mb-1 text-red-700">Gastos Anuales (del año actual)</h3><p id="gastos-anual-total" class="text-3xl font-bold text-red-800">$0.00</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4" id="gasto-form-title">Cargar Insumo</h3>
                            <form id="form-gasto" class="space-y-4">
                                <input type="hidden" id="gasto-id">
                                <div><label for="gasto-insumo-nombre" class="block mb-1 font-medium">Nombre de Insumo</label><input type="text" id="gasto-insumo-nombre" class="form-input" required></div>
                                <div><label for="gasto-monto" class="block mb-1 font-medium">Costo/Valor del Lote ($)</label><input type="number" id="gasto-monto" class="form-input" step="any" required min="0"></div>
                                <div>
                                    <label for="gasto-insumo-tipo" class="block mb-1 font-medium">Tipo</label>
                                    <select id="gasto-insumo-tipo" class="form-input" required>
                                        <option value="">Seleccione un tipo</option>
                                        <option value="Unidad">Unidad</option>
                                        <option value="Kg">Kg</option>
                                    </select>
                                </div>
                                <div><label for="gasto-insumo-stock" class="block mb-1 font-medium">Stock (Cantidad Total del Lote)</label><input type="number" id="gasto-insumo-stock" class="form-input" step="any" required min="0"></div>
                                
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="text-md font-semibold mb-3 text-gray-700">Opciones de Visibilidad en Combos</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="gasto-ocultar-combo" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <label for="gasto-ocultar-combo" class="ml-2 block text-sm font-medium text-gray-900">Ocultar en detalle del Combo</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="gasto-ocultar-tipo-cantidad" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <label for="gasto-ocultar-tipo-cantidad" class="ml-2 block text-sm font-medium text-gray-900">Ocultar 'Tipo' y Cantidad</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-end gap-4 pt-2"><button type="button" id="btn-cancelar-gasto" class="btn bg-gray-300 hover:bg-gray-400 hidden">Cancelar</button><button type="submit" id="btn-guardar-gasto" class="btn btn-primary">Guardar Insumo</button></div>
                            </form>
                        </div>
                         <div class="card">
                            <h3 class="text-xl font-semibold mb-4">Ingresar Gasto Rápido</h3>
                            <form id="form-gasto-rapido" class="space-y-4">
                                <div>
                                    <label for="gasto-rapido-monto" class="block mb-1 font-medium">Monto del Gasto ($)</label>
                                    <input type="number" id="gasto-rapido-monto" class="form-input" step="any" required min="0" placeholder="Ej: 5000">
                                </div>
                                <div class="flex justify-end pt-2">
                                    <button type="submit" class="btn btn-secondary w-full">Agregar Gasto Rápido</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4">Historial de Gastos e Insumos</h3>
                            <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Nombre/Descripción</th><th class="p-4">Tipo</th><th class="p-4">Stock Actual</th><th class="p-4">Monto/Costo Original</th><th class="p-4">Valor Actual</th><th class="p-4">Acciones</th></tr></thead><tbody id="tabla-gastos"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportes" class="view">
                 <!-- Contenido de Reportes sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Reportes y Análisis</h2>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Historial de Ventas</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Cliente</th>
                                    <th class="p-4">Forma de Pago</th>
                                    <th class="p-4">Total</th>
                                    <th class="p-4">Ganancia Est.</th>
                                    <th class="p-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-ventas"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="descuentos" class="view">
                 <!-- Contenido de Descuentos sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Gestión de Descuentos</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card lg:col-span-1 flex flex-col gap-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Generar Código QR de Descuento Especial</h3>
                            <form id="form-descuento-especial" class="space-y-4">
                                <div>
                                    <label for="special-discount-reason" class="block mb-1 font-medium">Descripción o Motivo</label>
                                    <input type="text" id="special-discount-reason" class="form-input" placeholder="Ej: Cumpleaños de Juan" required>
                                </div>
                                <div>
                                    <label for="special-discount-value" class="block mb-1 font-medium">Valor del Descuento (%)</label>
                                    <input type="number" id="special-discount-value" class="form-input" required min="1" max="100">
                                </div>
                                <div class="space-y-2 pt-2 border-t mt-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="special-discount-single-use" name="usageType" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <label for="special-discount-single-use" class="ml-2 block text-sm font-medium text-gray-700">Código de un solo uso (válido por 7 días)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="special-discount-multiple-use" name="usageType" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <label for="special-discount-multiple-use" class="ml-2 block text-sm font-medium text-gray-700">Código de uso múltiple (válido por 7 días)</label>
                                    </div>
                                </div>
                                <div class="pt-2">
                                    <button type="submit" class="btn btn-secondary w-full">Generar QR y Guardar</button>
                                </div>
                            </form>
                             <div id="special-qr-card" class="mt-6 border rounded-lg bg-white text-center hidden">
                                <div class="p-5">
                                    <div id="special-qr-code-container" class="mb-4 inline-block"></div>
                                    <p id="qr-card-title" class="font-bold text-xl"></p>
                                    <p id="qr-card-disclaimer" class="text-sm text-gray-600 mt-2 max-w-xs mx-auto"></p>
                                    <hr class="my-3 max-w-xs mx-auto">
                                    <p id="qr-card-expiry" class="text-xs text-gray-500"></p>
                                </div>
                                <div class="bg-gray-100 p-2 border-t">
                                     <button id="btn-download-qr" class="btn btn-primary w-full">Descargar QR</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4">Códigos Generados</h3>
                            <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Cliente/Motivo</th><th class="p-4">Código</th><th class="p-4">Valor (%)</th><th class="p-4">Tipo de Uso</th><th class="p-4">Vencimiento (Fecha y Hora)</th><th class="p-4">Acciones</th></tr></thead><tbody id="tabla-descuentos"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="efemerides" class="view">
                 <!-- Contenido de Efemérides sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Recordatorios de Eventos</h2>
                
                <div id="efemerides-notifications-container" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>

                <h3 class="text-2xl font-bold mb-4 mt-8">Calendario de Feriados y Efemérides</h3>
                <div class="card overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b">
                                <th class="p-4">Evento</th>
                                <th class="p-4">Fecha</th>
                                <th class="p-4">Días Restantes</th>
                                <th class="p-4">Tipo</th>
                                <th class="p-4">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-efemerides">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="configuracion" class="view">
                 <!-- Contenido de Configuración sin cambios -->
                <h2 class="text-3xl font-bold mb-6">Configuración del Sistema</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Parámetros Generales</h3>
                        <form id="form-config" class="space-y-4">
                            <div>
                                <label for="config-pago-porcentaje" class="block mb-1 font-medium">Porcentaje de Mi Pago (sobre Ganancia)</label>
                                <input type="number" id="config-pago-porcentaje" class="form-input" step="any" min="0" max="100" required>
                            </div>
                            <div>
                                <label for="config-stock-minimo" class="block mb-1 font-medium">Umbral de Stock Bajo (unidades)</label>
                                <input type="number" id="config-stock-minimo" class="form-input" min="0" required>
                            </div>
                            <div>
                                <label for="config-instagram-url" class="block mb-1 font-medium">Link de Instagram</label>
                                <input type="url" id="config-instagram-url" class="form-input" placeholder="Ej: https://instagram.com/perypie">
                            </div>
                            <div>
                                <label for="config-whatsapp-empleado" class="block mb-1 font-medium">N° WhatsApp (Empleado)</label>
                                <input type="text" id="config-whatsapp-empleado" class="form-input" placeholder="Ej: 5493425555555">
                            </div>
                            <div>
                                <label for="config-descuento-compra" class="block mb-1 font-medium">Descuento por Compra (%)</label>
                                <input type="number" id="config-descuento-compra" class="form-input" step="any" min="0" max="100">
                            </div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Gestión de Datos</h3>
                        <div class="space-y-4">
                            <button id="btn-reset-data" class="btn btn-danger w-full"><i class="fas fa-exclamation-triangle mr-2"></i> Reiniciar TODO el Sistema (Borra todos los datos)</button>
                            <button id="btn-reset-monetary" class="btn btn-danger w-full bg-red-700 hover:bg-red-800"><i class="fas fa-sync-alt mr-2"></i> Reiniciar Datos Monetarios (Ventas, Ganancias, Mi Pago)</button>
                            <hr>
                            <button id="btn-download-data" class="btn bg-gray-600 hover:bg-gray-700 text-white w-full"><i class="fas fa-download mr-2"></i> Descargar Copia de Seguridad</button>
                            <input type="file" id="upload-file-input" class="hidden" accept=".json,application/json">
                            <button id="btn-upload-data" class="btn bg-gray-600 hover:bg-gray-700 text-white w-full"><i class="fas fa-upload mr-2"></i> Cargar Copia de Seguridad</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Funciones de utilidad auxiliares
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 }).format(amount);
        }
        
        function formatCurrencyForLabel(amount) {
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            try {
                return adjustedDate.toLocaleDateString('es-AR', options);
            } catch {
                return dateString;
            }
        }
        
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const options = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            };
            try {
                // Formatea la fecha y hora, y elimina la coma que algunos navegadores agregan
                return new Intl.DateTimeFormat('es-AR', options).format(date).replace(',', '');
            } catch {
                return isoString; // Fallback
            }
        }

        function formatQrExpiry(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `Vigente hasta ${day}/${month}/${year}; ${hours}:${minutes} hs.`;
        }

        function formatDateForDisplay(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            // Ajustar por la zona horaria para evitar errores de un día
            const adjustedDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
            return adjustedDate.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function openModal({ title, body, confirmText, confirmStyle, onConfirm }) {
            const modal = document.getElementById('generic-modal');
            document.getElementById('modal-title').innerHTML = title;
            document.getElementById('modal-body').innerHTML = body;
            
            const footer = document.getElementById('modal-footer');
            footer.innerHTML = `
                <button id="modal-cancel-btn" class="btn bg-gray-300 hover:bg-gray-400">Cancelar</button>
                <button id="modal-confirm-btn" class="btn ${confirmStyle || 'btn-primary'}">${confirmText || 'Confirmar'}</button>
            `;

            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal, { once: true });
            document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                onConfirm();
            }, { once: true });

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('generic-modal').classList.remove('active');
            const footer = document.getElementById('modal-footer');
            footer.innerHTML = '';
        }

        // --- IndexedDB Wrapper ---
        class IndexedDBWrapper {
            constructor(dbName, version, stores) {
                this.dbName = dbName;
                this.version = version;
                this.stores = stores;
            }

            open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = (event) => {
                        reject('IndexedDB error: ' + event.target.error);
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this);
                    };

                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        this.stores.forEach(store => {
                            if (!this.db.objectStoreNames.contains(store.name)) {
                                const objectStore = this.db.createObjectStore(store.name, { keyPath: store.keyPath, autoIncrement: store.autoIncrement });
                                if (store.indexes) {
                                    store.indexes.forEach(index => {
                                        objectStore.createIndex(index.name, index.key, { unique: index.unique });
                                    });
                                }
                            }
                        });
                    };
                });
            }

            transaction(storeNames, mode) {
                return this.db.transaction(storeNames, mode);
            }

            get(storeName, key) {
                return new Promise((resolve, reject) => {
                    const request = this.transaction(storeName, 'readonly').objectStore(storeName).get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            getAll(storeName) {
                return new Promise((resolve, reject) => {
                    const request = this.transaction(storeName, 'readonly').objectStore(storeName).getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            put(storeName, value, key) {
                return new Promise((resolve, reject) => {
                    const tx = this.transaction(storeName, 'readwrite');
                    let storedKey;
                    tx.oncomplete = () => resolve(storedKey);
                    tx.onerror = (e) => reject(e.target.error);
                    
                    const store = tx.objectStore(storeName);
                    const request = key !== undefined ? store.put(value, key) : store.put(value);
                    
                    request.onsuccess = () => {
                        storedKey = request.result;
                    };
                });
            }
            
            delete(storeName, key) {
                return new Promise((resolve, reject) => {
                    const tx = this.transaction(storeName, 'readwrite');
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                    tx.objectStore(storeName).delete(key);
                });
            }

            clear(storeName) {
                 return new Promise((resolve, reject) => {
                    const tx = this.transaction(storeName, 'readwrite');
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                    tx.objectStore(storeName).clear();
                });
            }
        }

        // --- Core Application Logic ---
        class App {
            constructor() {
                this.db = null;
                this.productos = [];
                this.combos = [];
                this.clientes = [];
                this.ventas = [];
                this.gastos = [];
                this.descuentos = [];
                this.efemerides = [];
                this.config = {};
                this.carrito = [];
                this.currentComboItems = [];
                
                this.configDefaults = {
                    'config-pago-porcentaje': 30,
                    'config-stock-minimo': 5,
                    'config-instagram-url': 'https://instagram.com/perypie',
                    'config-whatsapp-empleado': '',
                    'config-descuento-compra': 10,
                    'efemerides_last_year_loaded': null
                };

                this.DB_STORES = [
                    { name: 'config', keyPath: 'id', autoIncrement: false },
                    { name: 'productos', keyPath: 'id', autoIncrement: true, indexes: [{ name: 'nombre', key: 'nombre', unique: true }] },
                    { name: 'combos', keyPath: 'id', autoIncrement: true, indexes: [{ name: 'nombre', key: 'nombre', unique: true }] },
                    { name: 'clientes', keyPath: 'id', autoIncrement: true, indexes: [{ name: 'nombre', key: 'nombre', unique: false }] },
                    { name: 'ventas', keyPath: 'id', autoIncrement: true, indexes: [{ name: 'fecha', key: 'fecha', unique: false }] },
                    { name: 'gastos', keyPath: 'id', autoIncrement: true, indexes: [{ name: 'fecha', key: 'fecha', unique: false }, { name: 'nombreInsumo', key: 'nombreInsumo', unique: false }] },
                    { name: 'descuentos', keyPath: 'id', autoIncrement: true, indexes: [{ name: 'codigo', key: 'codigo', unique: true }, { name: 'nombre', key: 'nombre', unique: false }, { name: 'whatsapp', key: 'whatsapp', unique: false }] },
                    { name: 'efemerides', keyPath: 'id', autoIncrement: true, indexes: [{ name: 'fecha', key: 'fecha', unique: false }] },
                ];
            }

            async init() {
                try {
                    // DB Version incremented to handle new indexes
                    this.db = await new IndexedDBWrapper('PER_PIE_DB', 6, this.DB_STORES).open();
                    console.log("IndexedDB Abierta y lista.");
                    this.attachListeners();
                    await this.loadAllData();
                    await this.initEfemerides(); // Llama al nuevo módulo de efemérides
                    this.switchView('dashboard');
                } catch (error) {
                    showToast('Error al inicializar la base de datos.', 'error');
                    console.error("Initialization error:", error);
                }
            }
            
            // Helper function for text wrapping on canvas, moved to be a class method
            _wrapText(context, text, maxWidth) {
                const words = text.split(' ');
                let lines = [];
                let currentLine = words[0];

                for (let i = 1; i < words.length; i++) {
                    let word = words[i];
                    let width = context.measureText(currentLine + " " + word).width;
                    if (width < maxWidth) {
                        currentLine += " " + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                }
                lines.push(currentLine);
                return lines;
            }

            // =================================================================
            // INICIO: NUEVAS FUNCIONES PARA EL GENERADOR DE ETIQUETAS
            // =================================================================
            openLabelGenerator(comboId) {
                const combo = this.combos.find(c => c.id === comboId);
                if (!combo) {
                    showToast('No se pudo encontrar el combo seleccionado.', 'error');
                    return;
                }

                // Poblar los datos en la etiqueta del modal
                document.getElementById('etiqueta-visor-imagen').src = combo.imagen || 'https://placehold.co/300x200/e2e8f0/adb5bd?text=Combo';
                document.getElementById('etiqueta-promo-title').innerText = combo.nombre.toUpperCase();
                
                document.getElementById('etiqueta-promo-price').innerText = formatCurrencyForLabel(combo.precio);
                
                // MEJORA 1: Se inserta el texto solicitado debajo del precio, con un salto de línea y centrado (hereda de su contenedor).
                document.getElementById('etiqueta-promo-description').innerHTML = "Descubre la calidad y el ahorro.<br>¿Te Guardamos un Combo?";

                const listElement = document.getElementById('etiqueta-promo-list');
                listElement.innerHTML = '';
                const items = combo.items || combo.productos || [];
                
                items.forEach(item => {
                    const listItem = document.createElement('li');
                    const itemName = item.nombre; 

                    const insumoDetails = item.type === 'insumo' ? this.gastos.find(g => g.id === item.id) : null;
                    if (insumoDetails) {
                        if (insumoDetails.ocultarEnCombo) return; 
                        if (insumoDetails.ocultarTipoYCantidad) {
                            listItem.innerHTML = `<span>${itemName}</span>`;
                            listElement.appendChild(listItem);
                            return; 
                        }
                    }
                    
                    listItem.innerHTML = `<strong>${item.cantidad}</strong> x <span>${itemName}</span>`;
                    listElement.appendChild(listItem);
                });

                // --- INICIO MEJORA 2: AJUSTE DINÁMICO DE TEXTO ---
                // Se ajusta el tamaño de fuente de todo el bloque de texto si el contenido general se desborda,
                // para mantener la proporción y asegurar que todo sea visible en la imagen final.
                setTimeout(() => {
                    const contentArea = document.getElementById('etiqueta-visor-contenido');
                    const textBlock = document.getElementById('etiqueta-text-block');
                    
                    // Restablecer el tamaño de fuente para un nuevo cálculo
                    textBlock.style.fontSize = '1em';

                    // Comprobar si el contenido total (imagen + texto) es más alto que el área visible
                    if (contentArea.scrollHeight > contentArea.clientHeight) {
                        let currentSize = 1; // em
                        // Reducir el tamaño de la fuente del bloque de texto hasta que el contenido encaje
                        while (contentArea.scrollHeight > contentArea.clientHeight && currentSize > 0.5) {
                            currentSize -= 0.02;
                            textBlock.style.fontSize = `${currentSize}em`;
                        }
                    }
                }, 50);
                // --- FIN MEJORA 2 ---

                // Mostrar el modal
                document.getElementById('label-generator-modal').classList.add('active');
            }

            closeLabelGenerator() {
                document.getElementById('label-generator-modal').classList.remove('active');
            }
            
            downloadLabelAsPNG() {
                const elementToCapture = document.getElementById('etiqueta-area-captura-final');
                const comboName = document.getElementById('etiqueta-promo-title').innerText;
                
                if (!elementToCapture) {
                    showToast('Error: No se encontró el área de la etiqueta para capturar.', 'error');
                    return;
                }
                
                showToast('Generando imagen, por favor espera...');

                html2canvas(elementToCapture, {
                    scale: 3, 
                    useCORS: true, 
                    backgroundColor: '#f3f4f6'
                }).then(canvas => {
                    const imageURL = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = imageURL;
                    const safeFileName = comboName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    link.download = `etiqueta_combo_${safeFileName}.png`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast('¡Etiqueta descargada con éxito!', 'success');
                }).catch(error => {
                    console.error('Error al generar la imagen con html2canvas:', error);
                    showToast('Ocurrió un error al generar la imagen.', 'error');
                });
            }
            
            // =================================================================
            // MÓDULO DE COPIA DE SEGURIDAD (Backup)
            // =================================================================
            
            async downloadBackup() {
                this.showLoading();
                try {
                    const backupData = {};
                    // Itera sobre todos los almacenes de objetos definidos para la DB
                    for (const store of this.DB_STORES) {
                        backupData[store.name] = await this.db.getAll(store.name);
                    }

                    // Convierte el objeto con todos los datos a un string JSON formateado
                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    // Crea un enlace temporal para iniciar la descarga
                    const a = document.createElement('a');
                    a.href = url;
                    const today = new Date().toISOString().slice(0, 10);
                    a.download = `PER_PIE_backup_${today}.json`; // Nombre del archivo
                    document.body.appendChild(a);
                    a.click(); // Simula el clic para descargar
                    document.body.removeChild(a); // Limpia el enlace
                    URL.revokeObjectURL(url); // Libera la memoria

                    showToast('Copia de seguridad descargada con éxito.', 'success');
                } catch (error) {
                    console.error('Error al descargar la copia de seguridad:', error);
                    showToast('No se pudo generar la copia de seguridad.', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            loadBackup() {
                // Pide confirmación antes de sobrescribir los datos
                openModal({
                    title: "⚠️ Cargar Copia de Seguridad",
                    body: "Esta acción <strong>sobrescribirá TODOS los datos actuales</strong> con los del archivo de respaldo. Esta operación no se puede deshacer. ¿Desea continuar?",
                    confirmText: "Sí, cargar respaldo",
                    confirmStyle: "btn-danger",
                    onConfirm: () => {
                        closeModal();
                        document.getElementById('upload-file-input').click(); // Activa el input de archivo oculto
                    }
                });
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showLoading();
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validación básica para asegurar que el archivo tiene el formato correcto
                        const storeNames = this.DB_STORES.map(s => s.name);
                        const backupKeys = Object.keys(backupData);
                        const isValid = storeNames.every(name => backupKeys.includes(name));

                        if (!isValid) {
                            throw new Error('El archivo de copia de seguridad no tiene el formato correcto.');
                        }

                        // Proceso de carga: limpiar cada almacén y llenarlo con los nuevos datos
                        for (const storeName of storeNames) {
                            await this.db.clear(storeName);
                            const items = backupData[storeName] || [];
                            for (const item of items) {
                                await this.db.put(storeName, item);
                            }
                        }

                        await this.loadAllData(); // Recarga toda la aplicación con los datos nuevos
                        showToast('Copia de seguridad cargada y aplicada con éxito.', 'success');
                        this.switchView('dashboard'); // Vuelve al dashboard

                    } catch (error) {
                        console.error('Error al cargar la copia de seguridad:', error);
                        showToast(`Error: ${error.message}`, 'error');
                    } finally {
                        this.hideLoading();
                        event.target.value = null; // Resetea el input para permitir cargar el mismo archivo de nuevo
                    }
                };
                reader.onerror = () => {
                    showToast('Error al leer el archivo.', 'error');
                    this.hideLoading();
                };
                reader.readAsText(file);
            }

            // =================================================================
            // MÓDULO DE FERIADOS Y EFEMÉRIDES
            // =================================================================

            async initEfemerides() {
                const currentYear = new Date().getFullYear();
                if (this.config.efemerides_last_year_loaded !== currentYear) {
                    console.log(`Cargando efemérides para el año ${currentYear}...`);
                    try {
                        await this.db.clear('efemerides');
                        const events = this.generateEfemeridesData(currentYear);
                        const promises = events.map(event => this.db.put('efemerides', event));
                        await Promise.all(promises);

                        // Actualizar la configuración
                        this.config.efemerides_last_year_loaded = currentYear;
                        await this.db.put('config', { ...this.config, id: 1 });

                        showToast(`Feriados y efemérides del ${currentYear} cargados.`, 'success');
                    } catch (error) {
                         showToast('Error al cargar los feriados del año.', 'error');
                         console.error("Error populating efemerides:", error);
                         return; // No continuar si falla la carga
                    }
                }
                
                await this.loadEfemerides();
                this.checkUpcomingEventNotifications();
            }

            calculateEaster(year) {
                const f = Math.floor,
                    a = year % 19,
                    b = year % 4,
                    c = year % 7,
                    k = f(year / 100),
                    p = f((13 + 8 * k) / 25),
                    q = f(k / 4),
                    M = (15 - p + k - q) % 30,
                    N = (4 + k - q) % 7,
                    d = (19 * a + M) % 30,
                    e = (2 * b + 4 * c + 6 * d + N) % 7;
                
                const day = (d + e < 10) ? 22 + d + e : d + e - 9;
                const month = (d + e < 10) ? 2 : 3; // March or April
                
                let easterDate = new Date(year, month, day);

                if (day === 26 && month === 3) easterDate = new Date(year, 2, 19);
                if (day === 25 && month === 3 && d === 28 && e === 6 && a > 10) easterDate = new Date(year, 2, 18);
                
                return easterDate;
            }
            
            findNthDayOfWeek(year, monthIndex, dayOfWeek, n) {
                const date = new Date(year, monthIndex, 1);
                let count = 0;
                while (count < n) {
                    if (date.getDay() === dayOfWeek) {
                        count++;
                    }
                    if (count < n) {
                        date.setDate(date.getDate() + 1);
                    }
                }
                return date;
            }

            generateEfemeridesData(year) {
                const easter = this.calculateEaster(year);
                
                const events = [
                    { nombre: 'Año Nuevo', emoji: '🎆', fecha: new Date(year, 0, 1), tipo: 'Nacional', alertDays: 20 },
                    { nombre: 'Día de los Veteranos y Caídos en Malvinas', emoji: '🇦🇷', fecha: new Date(year, 3, 2), tipo: 'Nacional', alertDays: 30 },
                    { nombre: 'Revolución de Mayo', emoji: '🇦🇷', fecha: new Date(year, 4, 25), tipo: 'Nacional', alertDays: 30 },
                    { nombre: 'Paso a la Inmortalidad de Güemes', emoji: '🇦🇷', fecha: new Date(year, 5, 17), tipo: 'Nacional', alertDays: 30 },
                    { nombre: 'Paso a la Inmortalidad de Belgrano', emoji: '🇦🇷', fecha: new Date(year, 5, 20), tipo: 'Nacional', alertDays: 30 },
                    { nombre: 'Día de la Independencia', emoji: '🇦🇷', fecha: new Date(year, 6, 9), tipo: 'Nacional', alertDays: 30 },
                    { nombre: 'Día del Amigo', emoji: '🧑‍🤝‍🧑', fecha: new Date(year, 6, 20), tipo: 'Social', alertDays: 45 },
                    { nombre: 'Paso a la Inmortalidad de San Martín', emoji: '🇦🇷', fecha: new Date(year, 7, 17), tipo: 'Nacional', alertDays: 30 },
                    { nombre: 'Primavera / Día del Estudiante', emoji: '🌸', fecha: new Date(year, 8, 21), tipo: 'Social', alertDays: 45 },
                    { nombre: 'Día del Respeto a la Diversidad Cultural', emoji: '🌎', fecha: new Date(year, 9, 12), tipo: 'Nacional', alertDays: 30 },
                    { nombre: 'Navidad', emoji: '🎄', fecha: new Date(year, 11, 25), tipo: 'Religioso', alertDays: 20 },
                    { nombre: 'Carnaval', emoji: '🎭', fecha: new Date(easter.getTime() - 48 * 24 * 60 * 60 * 1000), tipo: 'Nacional', alertDays: 45 },
                    { nombre: 'Carnaval', emoji: '🎭', fecha: new Date(easter.getTime() - 47 * 24 * 60 * 60 * 1000), tipo: 'Nacional', alertDays: 45 },
                    { nombre: 'Viernes Santo', emoji: '✝️', fecha: new Date(easter.getTime() - 2 * 24 * 60 * 60 * 1000), tipo: 'Religioso', alertDays: 30 },
                    { nombre: 'Pascuas', emoji: '🐰', fecha: easter, tipo: 'Religioso', alertDays: 30 },
                    { nombre: 'Día del Padre', emoji: '👨‍👧‍👦', fecha: this.findNthDayOfWeek(year, 5, 0, 3), tipo: 'Social', alertDays: 45 },
                    { nombre: 'Día de la Madre', emoji: '👩‍👧‍👦', fecha: this.findNthDayOfWeek(year, 9, 0, 3), tipo: 'Social', alertDays: 45 },
                ];
                
                return events.map(e => ({
                    ...e,
                    fecha: e.fecha.toISOString().split('T')[0]
                }));
            }
            
            renderEfemeridesTable() {
                const tbody = document.getElementById('tabla-efemerides');
                tbody.innerHTML = '';

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const sortedEvents = [...this.efemerides].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

                sortedEvents.forEach(event => {
                    const eventDate = new Date(event.fecha);
                    eventDate.setTime(eventDate.getTime() + eventDate.getTimezoneOffset() * 60000); // Timezone adjustment

                    const diffTime = eventDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let status, statusClass, remainingText;
                    if (diffDays < 0) {
                        status = 'Pasado';
                        statusClass = 'event-status-pasado';
                        remainingText = '-';
                    } else if (diffDays === 0) {
                        status = 'Hoy';
                        statusClass = 'event-status-hoy';
                        remainingText = '¡Es Hoy!';
                    } else {
                        status = 'Próximo';
                        statusClass = 'event-status-proximo';
                        remainingText = `Faltan ${diffDays} día${diffDays > 1 ? 's' : ''}`;
                    }

                    const row = tbody.insertRow();
                    if (diffDays >= 0 && diffDays < 15) {
                        row.className = 'event-highlight-proximo';
                    }

                    row.innerHTML = `
                        <td class="p-4">${event.emoji} ${event.nombre}</td>
                        <td class="p-4">${formatDateForDisplay(eventDate)}</td>
                        <td class="p-4">${remainingText}</td>
                        <td class="p-4">${event.tipo}</td>
                        <td class="p-4"><span class="${statusClass}">${status}</span></td>
                    `;
                });
            }
            
            checkUpcomingEventNotifications() {
                const container = document.getElementById('efemerides-notifications-container');
                container.innerHTML = '';
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // 1. Check for holidays based on their specific alert days
                const upcomingHolidays = this.efemerides.filter(event => {
                    const eventDate = new Date(event.fecha);
                    const diffTime = (eventDate.getTime() + eventDate.getTimezoneOffset() * 60000) - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays >= 0 && diffDays <= event.alertDays;
                });

                upcomingHolidays.forEach(event => this.showHolidayNotificationCard(event));

                // 2. Check for client birthdays (today and tomorrow)
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);

                const todayMonth = today.getMonth();
                const todayDay = today.getDate();
                const tomorrowMonth = tomorrow.getMonth();
                const tomorrowDay = tomorrow.getDate();

                this.clientes.forEach(cliente => {
                    if (cliente.fechaNacimiento) {
                        const parts = cliente.fechaNacimiento.split('-');
                        const birthMonth = parseInt(parts[1], 10) - 1; // JS months are 0-11
                        const birthDay = parseInt(parts[2], 10);

                        if (birthMonth === todayMonth && birthDay === todayDay) {
                            this.showBirthdayNotificationCard(cliente, 'hoy');
                        } else if (birthMonth === tomorrowMonth && birthDay === tomorrowDay) {
                            this.showBirthdayNotificationCard(cliente, 'mañana');
                        }
                    }
                });
            }

            showHolidayNotificationCard(event) {
                const container = document.getElementById('efemerides-notifications-container');
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const eventDate = new Date(event.fecha);
                const diffTime = (eventDate.getTime() + eventDate.getTimezoneOffset() * 60000) - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const remainingText = diffDays === 0 ? "¡Es Hoy!" : `Faltan ${diffDays} día${diffDays > 1 ? 's' : ''}`;

                const card = document.createElement('div');
                card.className = 'notification-card';
                card.innerHTML = `
                    <div class="notification-card-header">
                        ${event.emoji} ${event.nombre}
                    </div>
                    <div class="notification-card-body">
                        Fecha: ${formatDateForDisplay(eventDate)} — <strong>${remainingText}</strong>
                    </div>
                    <div class="notification-card-footer">
                        <button class="btn btn-dismiss">Marcar como recordado</button>
                    </div>
                `;

                card.querySelector('.btn-dismiss').addEventListener('click', () => {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.95)';
                    setTimeout(() => card.remove(), 300);
                });
                
                container.appendChild(card);
            }

            showBirthdayNotificationCard(cliente, status) {
                const container = document.getElementById('efemerides-notifications-container');

                let titleText = `🎂 Cumpleaños de ${cliente.nombre}`;
                let bodyText = '';
                if (status === 'hoy') {
                    bodyText = `¡Hoy es su cumpleaños!`;
                } else if (status === 'mañana') {
                    bodyText = `Mañana es su cumpleaños.`;
                }

                const card = document.createElement('div');
                card.className = 'notification-card';
                
                let footerHtml = '';
                if (cliente.telefono) {
                    const message = encodeURIComponent(`¡Feliz cumpleaños, ${cliente.nombre}! 🎉 Te deseamos un día genial. ¡Saludos de parte de PER & PIE Bebidas!`);
                    const phone = cliente.telefono.replace(/\D/g, '');
                    footerHtml += `<a href="https://api.whatsapp.com/send?phone=${phone}&text=${message}" target="_blank" class="btn btn-whatsapp"><i class="fab fa-whatsapp mr-2"></i>Saludar</a>`;
                } else {
                    footerHtml += `<button class="btn btn-whatsapp" disabled>Sin teléfono</button>`;
                }
                footerHtml += `<button class="btn btn-dismiss">Marcar como recordado</button>`;

                card.innerHTML = `
                    <div class="notification-card-header">${titleText}</div>
                    <div class="notification-card-body"><strong>${bodyText}</strong></div>
                    <div class="notification-card-footer">${footerHtml}</div>
                `;

                card.querySelector('.btn-dismiss').addEventListener('click', () => {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.95)';
                    setTimeout(() => card.remove(), 300);
                });
                
                container.appendChild(card);
            }

            // =================================================================
            // FIN DEL MÓDULO DE EFEMÉRIDES
            // =================================================================

            showLoading() { document.getElementById('loading-indicator').style.opacity = '1'; }
            hideLoading() { document.getElementById('loading-indicator').style.opacity = '0'; }

            switchView(viewId) {
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
                document.querySelector(`.sidebar-link[data-view="${viewId}"]`).classList.add('active');
                
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('active');
                }

                // Lógica específica por vista
                if (viewId === 'stock') this.renderStockTable();
                if (viewId === 'dashboard') this.calculateAllStats();
                if (viewId === 'ventas' || viewId === 'reportes') {
                    this.renderVentaSelectors();
                    this.renderCarrito();
                    this.renderVentasTable();
                }
                if (viewId === 'promociones') this.renderComboItemSelector();
                if (viewId === 'efemerides') this.renderEfemeridesTable();
            }
            
            async loadConfig() {
                try {
                    const savedConfig = await this.db.get('config', 1) || {};
                    this.config = { ...this.configDefaults, ...savedConfig };

                    document.getElementById('config-pago-porcentaje').value = this.config['config-pago-porcentaje'];
                    document.getElementById('config-stock-minimo').value = this.config['config-stock-minimo'];
                    document.getElementById('config-instagram-url').value = this.config['config-instagram-url'];
                    document.getElementById('config-whatsapp-empleado').value = this.config['config-whatsapp-empleado'];
                    document.getElementById('config-descuento-compra').value = this.config['config-descuento-compra'];
                    
                    this.updateInstagramLink();
                } catch (error) {
                    console.error("Error al cargar la configuración:", error);
                    this.config = { ...this.configDefaults }; // Fallback
                    showToast('No se pudo cargar la configuración, se usarán los valores por defecto.', 'error');
                }
            }

            updateInstagramLink() {
                const link = document.getElementById('instagram-link');
                link.href = this.config['config-instagram-url'] || '#';
            }

            saveConfig(e) {
                e.preventDefault();
                this.showLoading();
                const config = {
                    id: 1,
                    'config-pago-porcentaje': parseFloat(document.getElementById('config-pago-porcentaje').value) || 0,
                    'config-stock-minimo': parseInt(document.getElementById('config-stock-minimo').value) || 0,
                    'config-instagram-url': document.getElementById('config-instagram-url').value,
                    'config-whatsapp-empleado': document.getElementById('config-whatsapp-empleado').value,
                    'config-descuento-compra': parseFloat(document.getElementById('config-descuento-compra').value) || 0,
                    'efemerides_last_year_loaded': this.config.efemerides_last_year_loaded // Preservar el año cargado
                };
                
                this.db.put('config', config).then(() => {
                    this.config = { ...this.config, ...config };
                    this.updateInstagramLink();
                    this.calculateAllStats();
                    this.checkLowStock();
                    this.calculateProductPrices();
                    showToast('Configuración guardada correctamente.', 'success');
                }).catch(error => {
                    console.error("Error saving config:", error);
                    showToast('Error al guardar la configuración.', 'error');
                }).finally(() => {
                    this.hideLoading();
                });
            }

            resetMonetaryData() {
                openModal({
                    title: "⚠️ Confirmar Reinicio Monetario",
                    body: "Estás seguro que deseas **Reiniciar solo los datos monetarios**? Esto borrará permanentemente todo el Historial de **Ventas** y **Gastos**.",
                    confirmText: "Reiniciar Datos",
                    confirmStyle: "btn-danger",
                    onConfirm: async () => {
                        this.showLoading();
                        try {
                            await this.db.clear('ventas');
                            await this.db.clear('gastos');
                            await this.loadVentas();
                            await this.loadGastos();
                            this.calculateAllStats(); 
                            closeModal();
                            showToast('Datos monetarios reiniciados.', 'success');
                            this.switchView('dashboard');
                        } catch (error) {
                            showToast('Error al reiniciar los datos monetarios.', 'error');
                        } finally {
                            this.hideLoading();
                        }
                    }
                });
            }

            resetSystem() {
                openModal({
                    title: "⛔ Reinicio COMPLETO del Sistema",
                    body: "Estás seguro que deseas **Reiniciar TODO el sistema**? Esto borrará **PERMANENTEMENTE** todos los datos guardados.",
                    confirmText: "Borrar TODO",
                    confirmStyle: "btn-danger",
                    onConfirm: async () => {
                        this.showLoading();
                        try {
                            for (const store of this.DB_STORES.map(s => s.name)) {
                                await this.db.clear(store);
                            }
                            this.productos = [], this.combos = [], this.clientes = [], this.ventas = [], this.gastos = [], this.descuentos = [], this.efemerides = [];
                            await this.loadAllData();
                            await this.initEfemerides(); // Recargar efemérides después de borrar todo
                            showToast('Sistema reiniciado correctamente.', 'success');
                            this.switchView('dashboard');
                        } catch (error) {
                            showToast('Error al reiniciar el sistema.', 'error');
                        } finally {
                            closeModal();
                            this.hideLoading();
                        }
                    }
                });
            }

            async loadAllData() {
                this.showLoading();
                try {
                    await this.loadConfig();
                    await this.loadProductos();
                    await this.loadCombos();
                    await this.loadClientes();
                    await this.loadDescuentos();
                    await this.loadEfemerides();
                    await this.loadVentas();
                    await this.loadGastos();
                    
                    this.renderAllTablesAndSelectors();
                    this.calculateAllStats();
                    this.checkLowStock();
                } catch (error) {
                    showToast('Error al cargar todos los datos.', 'error');
                } finally {
                    this.hideLoading();
                }
            }
            
            renderAllTablesAndSelectors() {
                this.renderStockTable();
                this.renderComboItemSelector();
                this.renderClientesSelector();
                this.renderDescuentosSelector();
                this.renderCombosList();
                this.renderEfemeridesTable();
                this.renderDescuentosTable();
                this.renderClientesTable();
                this.renderVentasTable();
                this.renderVentaSelectors();
            }

            async loadProductos() { this.productos = await this.db.getAll('productos'); }
            async loadCombos() { this.combos = await this.db.getAll('combos'); }
            async loadClientes() { this.clientes = await this.db.getAll('clientes'); }
            async loadVentas() { this.ventas = await this.db.getAll('ventas'); }
            
            async loadDescuentos() { 
                await this.cleanupExpiredDiscounts(); // Run cleanup first
                this.descuentos = await this.db.getAll('descuentos'); 
            }

            async loadEfemerides() { this.efemerides = await this.db.getAll('efemerides'); }
            async loadGastos() { 
                this.gastos = await this.db.getAll('gastos'); 
                this.renderGastosTable();
                this.calculateAndRenderGastoTotals();
            }
            
            renderStockTable() {
                const tbody = document.getElementById('tabla-stock');
                tbody.innerHTML = '';

                const groupedProducts = this.productos.reduce((acc, p) => {
                    const category = p.categoria || 'Sin Categoría';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(p);
                    return acc;
                }, {});

                const sortedCategories = Object.keys(groupedProducts).sort((a, b) => a.localeCompare(b));

                sortedCategories.forEach(category => {
                    const headerRow = tbody.insertRow();
                    headerRow.className = 'bg-gray-200';
                    const headerCell = headerRow.insertCell();
                    headerCell.colSpan = 8;
                    headerCell.className = 'p-4 font-bold text-lg text-gray-700';
                    headerCell.textContent = category;

                    const productsInCategory = groupedProducts[category].sort((a, b) => a.nombre.localeCompare(b.nombre));

                    productsInCategory.forEach(p => {
                        const row = tbody.insertRow();
                        row.className = p.stock <= this.config['config-stock-minimo'] ? 'bg-yellow-100' : '';
                        
                        // SOLUCIÓN 1: Se reemplaza la celda de stock por el control interactivo.
                        row.innerHTML = `
                            <td class="p-4"><img src="${p.imagen || 'https://placehold.co/50x50/e2e8f0/adb5bd?text=N/A'}" alt="${p.nombre}" class="w-10 h-10 object-cover rounded"></td>
                            <td class="p-4">${p.nombre}</td>
                            <td class="p-4">${p.categoria}</td>
                            <td class="p-4">
                                <div class="flex items-center gap-3 justify-start">
                                    <button onclick="app.updateStock(${p.id}, -1)" class="stock-adjust-btn minus" title="Disminuir stock">-</button>
                                    <span class="font-bold text-lg min-w-[30px] text-center ${p.stock <= this.config['config-stock-minimo'] ? 'text-red-600' : ''}">${p.stock}</span>
                                    <button onclick="app.updateStock(${p.id}, 1)" class="stock-adjust-btn plus" title="Aumentar stock">+</button>
                                </div>
                            </td>
                            <td class="p-4">${formatCurrency(p.costo)}</td>
                            <td class="p-4">${formatCurrency(p.precio1)}</td>
                            <td class="p-4">${formatCurrency(p.precio2)}</td>
                            <td class="p-4 flex gap-2"><button onclick="app.editProducto(${p.id})" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="app.deleteProducto(${p.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
                        `;
                    });
                });
            }

            renderGastosTable() {
                const tbody = document.getElementById('tabla-gastos');
                tbody.innerHTML = '';
                this.gastos
                    .filter(g => !g.archivado) // No mostrar gastos archivados
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                    .forEach(g => {
                        const row = tbody.insertRow();
                        if (g.nombreInsumo) { // Es un Insumo
                            const montoOriginal = g.montoOriginal ?? g.monto;
                            const valorActual = g.valorActual ?? g.monto;
                            const stockDisplay = `${g.stockActual} ${g.tipo === 'Kg' ? 'Kg' : 'u.'}`;
                            row.innerHTML = `
                                <td class="p-4 font-semibold">${g.nombreInsumo}</td>
                                <td class="p-4">${g.tipo}</td>
                                <td class="p-4 font-bold ${g.stockActual <= 0 ? 'text-red-600' : ''}">${stockDisplay}</td>
                                <td class="p-4">${formatCurrency(montoOriginal)}</td>
                                <td class="p-4 font-bold text-blue-600">${formatCurrency(valorActual)}</td>
                                <td class="p-4 flex gap-2">
                                    <button onclick="app.editGasto(${g.id})" class="text-blue-500 hover:text-blue-700" title="Editar"><i class="fas fa-edit"></i></button>
                                    <button onclick="app.deleteGasto(${g.id})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        } else { // Es un Gasto General (Gasto Rápido o Reversión)
                            const montoOriginal = g.montoOriginal ?? g.monto;
                            row.className = montoOriginal < 0 ? 'bg-green-50' : '';
                            row.innerHTML = `
                                <td class="p-4 ${montoOriginal < 0 ? 'text-green-700' : ''}">${g.descripcion}</td>
                                <td class="p-4 italic text-gray-500">Gasto General</td>
                                <td class="p-4">---</td>
                                <td class="p-4 ${montoOriginal < 0 ? 'text-green-700' : ''}">${formatCurrency(montoOriginal)}</td>
                                <td class="p-4 ${montoOriginal < 0 ? 'text-green-700' : ''}">${formatCurrency(montoOriginal)}</td>
                                <td class="p-4 flex gap-2">
                                    <button title="Editar" disabled class="text-gray-300 cursor-not-allowed"><i class="fas fa-edit"></i></button>
                                    <button onclick="app.deleteGasto(${g.id})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                        }
                    });
            }
            
            renderDescuentosTable() {
                const tbody = document.getElementById('tabla-descuentos');
                tbody.innerHTML = '';
                const now = new Date();
                this.descuentos.sort((a, b) => new Date(b.vencimiento) - new Date(a.vencimiento));
                this.descuentos.forEach(d => {
                    const expirationDate = new Date(d.vencimiento);
                    const isExpired = now > expirationDate;
                    const row = tbody.insertRow();
                    row.className = isExpired ? 'bg-red-100 opacity-60' : '';

                    const usageTypeText = d.usageType === 'single' ? 'Uso Único' : (d.usageType === 'multiple' ? 'Uso Múltiple' : 'N/A');
                    const usageTypeClass = d.usageType === 'single' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';

                    row.innerHTML = `
                        <td class="p-4">${d.nombre}</td>
                        <td class="p-4 font-mono font-bold text-blue-600">${d.codigo}</td>
                        <td class="p-4">${d.valor}%</td>
                        <td class="p-2"><span class="px-2 py-1 text-xs font-semibold rounded-full ${usageTypeClass}">${usageTypeText}</span></td>
                        <td class="p-4">${formatDateTime(d.vencimiento)} ${isExpired ? '<span class="font-bold text-red-700">(Vencido)</span>' : ''}</td>
                        <td class="p-4 flex gap-2">
                            <button onclick="app.shareDescuentoOnWhatsApp(${d.id})" class="text-green-500 hover:text-green-700" title="Compartir por WhatsApp"><i class="fab fa-whatsapp"></i></button>
                            <button onclick="app.deleteDescuento(${d.id})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                });
            }

            shareDescuentoOnWhatsApp(id) {
                const descuento = this.descuentos.find(d => d.id === id);
                if (!descuento) {
                    showToast('No se encontró el descuento para compartir.', 'error');
                    return;
                }
                const clienteWhatsapp = descuento.whatsapp?.replace(/\D/g, '') || '';
                
                // --- INICIO DE LA MODIFICACIÓN ---
                const formattedVencimiento = formatDateTime(descuento.vencimiento);
                const message = `¡Hola ${descuento.nombre}! Tenés un cupón de descuento del ${descuento.valor}% en PER & PIE Bebidas. Tu código es: *${descuento.codigo}*. Vence el ${formattedVencimiento}. ¡Te esperamos!

\`\`\`Algunos productos ya incluyen descuento, por lo que no se aplican promociones adicionales.\`\`\``;
                // --- FIN DE LA MODIFICACIÓN ---

                let whatsappUrl;
                if(clienteWhatsapp) {
                    // Pre-fill number and message
                    whatsappUrl = `https://api.whatsapp.com/send?phone=${clienteWhatsapp}&text=${encodeURIComponent(message)}`;
                } else {
                    // Open WhatsApp with only the message, user chooses contact
                     whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                }
                
                window.open(whatsappUrl, '_blank');
            }

            calculateAndRenderGastoTotals() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                let monthlyTotal = 0;
                let yearlyTotal = 0;

                this.gastos.forEach(gasto => {
                    const gastoDate = new Date(gasto.fecha);
                    const amount = gasto.montoOriginal ?? gasto.monto;

                    if (gastoDate.getFullYear() === currentYear) {
                        yearlyTotal += amount;
                        if (gastoDate.getMonth() === currentMonth) {
                            monthlyTotal += amount;
                        }
                    }
                });
                
                document.getElementById('gastos-mensual-total').textContent = formatCurrency(monthlyTotal);
                document.getElementById('gastos-anual-total').textContent = formatCurrency(yearlyTotal);
            }

            adjustAdaptiveText() {
                const elements = document.querySelectorAll('.adaptive-text, .adaptive-text-large');

                elements.forEach(el => {
                    el.style.fontSize = '';
                    const parent = el.parentElement;
                    const parentStyles = window.getComputedStyle(parent);
                    const parentPaddingLeft = parseFloat(parentStyles.paddingLeft);
                    const parentPaddingRight = parseFloat(parentStyles.paddingRight);
                    const availableWidth = parent.clientWidth - parentPaddingLeft - parentPaddingRight;
                    el.style.whiteSpace = 'nowrap';

                    if (el.scrollWidth > availableWidth) {
                        const currentFontSize = parseFloat(window.getComputedStyle(el).fontSize);
                        const ratio = availableWidth / el.scrollWidth;
                        const newSize = Math.floor(currentFontSize * ratio * 0.98); 
                        el.style.fontSize = `${Math.max(12, newSize)}px`; 
                    }
                    el.style.whiteSpace = 'normal';
                });
            }

            async saveGastoRapido(e) {
                e.preventDefault();
                const monto = parseFloat(document.getElementById('gasto-rapido-monto').value);
                if (isNaN(monto) || monto <= 0) {
                    showToast('Por favor, ingrese un monto válido.', 'error');
                    return;
                }
                
                const gastoData = {
                    fecha: getTodayDateString(),
                    monto: monto,
                    montoOriginal: monto,
                    descripcion: "Gasto Rápido",
                    esGastoRapido: true
                };

                this.showLoading();
                try {
                    await this.db.put('gastos', gastoData);
                    showToast('Gasto rápido guardado con éxito.', 'success');
                    document.getElementById('form-gasto-rapido').reset();
                    await this.loadGastos();
                    this.calculateAllStats();
                } catch (error) {
                    showToast('Error al guardar el gasto.', 'error');
                    console.error("Error saving quick expense:", error);
                } finally {
                    this.hideLoading();
                }
            }
            
            async saveGasto(e) { // Guarda Insumos
                e.preventDefault();
                const id = document.getElementById('gasto-id').value ? parseInt(document.getElementById('gasto-id').value) : null;
                const valorDesdeForm = parseFloat(document.getElementById('gasto-monto').value);
                const stock = parseFloat(document.getElementById('gasto-insumo-stock').value);
                const nombre = document.getElementById('gasto-insumo-nombre').value.trim();
                const tipo = document.getElementById('gasto-insumo-tipo').value;
                const ocultarEnCombo = document.getElementById('gasto-ocultar-combo').checked;
                const ocultarTipoYCantidad = document.getElementById('gasto-ocultar-tipo-cantidad').checked;

                if (!nombre || !tipo || isNaN(valorDesdeForm) || valorDesdeForm < 0 || isNaN(stock) || stock <= 0) {
                    showToast('Todos los campos del insumo son obligatorios y deben ser válidos.', 'error');
                    return;
                }

                this.showLoading();
                try {
                    let gastoData;
                    if (id) { // Editando
                        const originalGasto = await this.db.get('gastos', id);
                        gastoData = { 
                            ...originalGasto, 
                            id, 
                            nombreInsumo: nombre, 
                            valorActual: valorDesdeForm,
                            tipo, 
                            stockActual: stock,
                            ocultarEnCombo,
                            ocultarTipoYCantidad
                        };
                    } else { // Creando nuevo
                        gastoData = {
                            fecha: getTodayDateString(),
                            monto: valorDesdeForm,
                            montoOriginal: valorDesdeForm,
                            valorActual: valorDesdeForm,
                            descripcion: `Carga de insumo: ${nombre}`,
                            nombreInsumo: nombre,
                            tipo: tipo,
                            stockOriginal: stock,
                            stockActual: stock,
                            ocultarEnCombo,
                            ocultarTipoYCantidad,
                        };
                    }
                    
                    await this.db.put('gastos', gastoData);
                    showToast(id ? 'Insumo actualizado con éxito.' : 'Insumo guardado con éxito.', 'success');
                    this.clearGastoForm();
                    await this.loadGastos();
                    await this.loadCombos();
                    this.renderCombosList();
                    this.calculateAllStats();
                } catch (error) {
                    showToast('Error al guardar el insumo.', 'error');
                    console.error("Error saving insumo:", error);
                } finally {
                    this.hideLoading();
                }
            }

            async editGasto(id) {
                this.showLoading();
                try {
                    const gasto = await this.db.get('gastos', id);
                    if (gasto) {
                         document.getElementById('gasto-id').value = gasto.id;
                        if (gasto.nombreInsumo) { // Es un Insumo
                            document.getElementById('gasto-insumo-nombre').value = gasto.nombreInsumo;
                            document.getElementById('gasto-monto').value = gasto.valorActual ?? gasto.montoOriginal ?? gasto.monto;
                            document.getElementById('gasto-insumo-tipo').value = gasto.tipo;
                            document.getElementById('gasto-insumo-stock').value = gasto.stockActual;
                            document.getElementById('gasto-ocultar-combo').checked = gasto.ocultarEnCombo || false;
                            document.getElementById('gasto-ocultar-tipo-cantidad').checked = gasto.ocultarTipoYCantidad || false;

                            document.getElementById('gasto-form-title').textContent = 'Editar Insumo';
                            document.getElementById('btn-guardar-gasto').textContent = 'Guardar Cambios';
                        } else {
                             showToast('La edición de gastos rápidos/reversiones no está implementada en este formulario.', 'error');
                             this.clearGastoForm();
                             return;
                        }

                        document.getElementById('btn-cancelar-gasto').classList.remove('hidden');
                        document.getElementById('gasto-form-title').scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (error) {
                    showToast('Error al cargar el gasto/insumo para editar.', 'error');
                } finally {
                    this.hideLoading();
                }
            }
            
            deleteGasto(id) {
                const bodyContent = `
                    <p>¿Estás seguro que deseas eliminar este registro?</p>
                    <div class="mt-4 flex items-center p-3 bg-gray-50 rounded-lg">
                        <input type="checkbox" id="revertir-gasto-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="revertir-gasto-checkbox" class="ml-3 block text-sm font-medium text-gray-800">Revertir Gasto del Insumo</label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <b>Si se marca:</b> se descuenta el costo original de los totales (el gasto se anula).
                        <br>
                        <b>Si no se marca:</b> el registro se oculta, pero las métricas de gastos no cambiarán.
                    </p>
                `;

                openModal({
                    title: "⚠️ Confirmar Eliminación",
                    body: bodyContent,
                    confirmText: "Eliminar",
                    confirmStyle: "btn-danger",
                    onConfirm: async () => {
                        const revertir = document.getElementById('revertir-gasto-checkbox').checked;
                        this.showLoading();
                        try {
                            if (revertir) {
                                // Revertir: La acción elimina financieramente el gasto.
                                // Al borrarlo, las métricas se recalcularán sin este valor.
                                await this.db.delete('gastos', id);
                                showToast('Gasto revertido y eliminado.', 'success');
                            } else {
                                // No revertir: Solo ocultar, las métricas no deben cambiar.
                                // Marcamos como archivado para ocultarlo de la tabla, pero se mantiene para los cálculos.
                                const gasto = await this.db.get('gastos', id);
                                if (gasto) {
                                    gasto.archivado = true;
                                    await this.db.put('gastos', gasto);
                                    showToast('Gasto archivado (oculto).', 'success');
                                }
                            }
                            
                            await this.loadGastos(); // Recarga y re-renderiza la tabla (filtrada)
                            this.calculateAllStats(); // Recalcula todas las métricas
                            closeModal();
                        } catch (error) {
                            showToast('Error al procesar el registro.', 'error');
                            console.error("Error deleting/archiving expense:", error);
                        } finally {
                            this.hideLoading();
                        }
                    }
                });
            }

            clearGastoForm() {
                document.getElementById('form-gasto').reset();
                document.getElementById('gasto-id').value = '';
                document.getElementById('gasto-ocultar-combo').checked = false;
                document.getElementById('gasto-ocultar-tipo-cantidad').checked = false;
                document.getElementById('gasto-form-title').textContent = 'Cargar Insumo';
                document.getElementById('btn-guardar-gasto').textContent = 'Guardar Insumo';
                document.getElementById('btn-cancelar-gasto').classList.add('hidden');
            }

            calculateAllStats() {
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).getTime();
                const startOfFortnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (now.getDate() % 15) +1).getTime();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();
                
                let miPagoStats = { hoy: 0, semanal: 0, quincenal: 0, mensual: 0, anual: 0 };
                let ventasStats = { hoy: 0, semanal: 0, quincenal: 0, mensual: 0, anual: 0 };
                let gananciaBrutaStats = { hoy: 0, semanal: 0, quincenal: 0, mensual: 0, anual: 0 };

                // Las ventas archivadas no se cuentan en las métricas.
                this.ventas.filter(v => !v.archivada).forEach(v => {
                    const totalVenta = v.total;
                    const gananciaVenta = v.ganancia || 0;
                    const miPagoVenta = v.miPago || 0;
                    const ventaDate = new Date(v.fecha).getTime();

                    if (ventaDate >= startOfDay) { miPagoStats.hoy += miPagoVenta; ventasStats.hoy += totalVenta; gananciaBrutaStats.hoy += gananciaVenta; }
                    if (ventaDate >= startOfWeek) { miPagoStats.semanal += miPagoVenta; ventasStats.semanal += totalVenta; gananciaBrutaStats.semanal += gananciaVenta; }
                    if (ventaDate >= startOfFortnight) { miPagoStats.quincenal += miPagoVenta; ventasStats.quincenal += totalVenta; gananciaBrutaStats.quincenal += gananciaVenta; }
                    if (ventaDate >= startOfMonth) { miPagoStats.mensual += miPagoVenta; ventasStats.mensual += totalVenta; gananciaBrutaStats.mensual += gananciaVenta; }
                    if (ventaDate >= startOfYear) { miPagoStats.anual += miPagoVenta; ventasStats.anual += totalVenta; gananciaBrutaStats.anual += gananciaVenta; }
                });
                
                let gananciaNetaStats = { ...gananciaBrutaStats };
                
                // Los gastos (incluidos los archivados) se cuentan en las métricas.
                this.gastos.forEach(g => {
                    const montoGasto = g.montoOriginal ?? g.monto;
                    const gastoDate = new Date(g.fecha).getTime();
                    if (gastoDate >= startOfDay) gananciaNetaStats.hoy -= montoGasto;
                    if (gastoDate >= startOfWeek) gananciaNetaStats.semanal -= montoGasto;
                    if (gastoDate >= startOfFortnight) gananciaNetaStats.quincenal -= montoGasto;
                    if (gastoDate >= startOfMonth) gananciaNetaStats.mensual -= montoGasto;
                    if (gastoDate >= startOfYear) gananciaNetaStats.anual -= montoGasto;
                });

                document.getElementById('dashboard-mi-pago-hoy').textContent = formatCurrency(miPagoStats.hoy);
                document.getElementById('dashboard-ganancia-hoy').textContent = formatCurrency(gananciaNetaStats.hoy);
                document.getElementById('dashboard-ventas-hoy').textContent = formatCurrency(ventasStats.hoy);

                document.getElementById('dashboard-mi-pago-semanal').textContent = formatCurrency(miPagoStats.semanal);
                document.getElementById('dashboard-mi-pago-quincenal').textContent = formatCurrency(miPagoStats.quincenal);
                document.getElementById('dashboard-mi-pago-mensual').textContent = formatCurrency(miPagoStats.mensual);
                document.getElementById('dashboard-mi-pago-anual').textContent = formatCurrency(miPagoStats.anual);

                document.getElementById('dashboard-ganancia-semanal').textContent = formatCurrency(gananciaNetaStats.semanal);
                document.getElementById('dashboard-ganancia-quincenal').textContent = formatCurrency(gananciaNetaStats.quincenal);
                document.getElementById('dashboard-ganancia-mensual').textContent = formatCurrency(gananciaNetaStats.mensual);
                document.getElementById('dashboard-ganancia-anual').textContent = formatCurrency(gananciaNetaStats.anual);
                
                document.getElementById('dashboard-ventas-semanal').textContent = formatCurrency(ventasStats.semanal);
                document.getElementById('dashboard-ventas-quincenal').textContent = formatCurrency(ventasStats.quincenal);
                document.getElementById('dashboard-ventas-mensual').textContent = formatCurrency(ventasStats.mensual);
                document.getElementById('dashboard-ventas-anual').textContent = formatCurrency(ventasStats.anual);
                
                setTimeout(() => this.adjustAdaptiveText(), 50);
            }

            checkLowStock() {
                const lowStockCount = this.productos.filter(p => p.stock <= this.config['config-stock-minimo']).length;
                const badge = document.getElementById('low-stock-badge');
                if (lowStockCount > 0) {
                    badge.textContent = lowStockCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
            
            async cleanupExpiredDiscounts() {
                console.log("Revisando descuentos vencidos...");
                const allDiscounts = await this.db.getAll('descuentos');
                const now = new Date();
                let deletedCount = 0;
                const promises = allDiscounts.map(d => {
                    const expirationDate = new Date(d.vencimiento);
                    if (now > expirationDate) {
                        deletedCount++;
                        return this.db.delete('descuentos', d.id);
                    }
                    return Promise.resolve();
                });
                await Promise.all(promises);
                if (deletedCount > 0) {
                    console.log(`${deletedCount} descuento(s) vencido(s) eliminado(s).`);
                }
            }
            
            // --- NUEVA FUNCIÓN ---
            // Limpia el formulario y la tarjeta del QR especial.
            clearSpecialQRSection() {
                document.getElementById('form-descuento-especial').reset();
                const qrCard = document.getElementById('special-qr-card');
                qrCard.classList.add('hidden');
                const qrContainer = document.getElementById('special-qr-code-container');
                qrContainer.innerHTML = ''; // Limpia el canvas/img del QR
            }

            // --- FUNCIÓN MODIFICADA ---
            async generateSpecialQRCode(e) {
                e.preventDefault();
                this.showLoading();
                try {
                    const reason = document.getElementById('special-discount-reason').value.trim();
                    const value = document.getElementById('special-discount-value').value;
                    const isSingleUse = document.getElementById('special-discount-single-use').checked;
                    const isMultipleUse = document.getElementById('special-discount-multiple-use').checked;
                    
                    if (!reason || !value) {
                        showToast('Por favor, complete el motivo y el valor del descuento.', 'error');
                        this.hideLoading();
                        return;
                    }

                    if (!isSingleUse && !isMultipleUse) {
                        showToast('Debe seleccionar un tipo de uso para el código (único o múltiple).', 'error');
                        this.hideLoading();
                        return;
                    }

                    if (typeof QRCode === 'undefined') {
                        throw new Error('La librería para generar QR no está disponible.');
                    }

                    const specialChars = '*#&';
                    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    const numbers = '0123456789';
                    let codeParts = [];
                    for (let i = 0; i < 5; i++) codeParts.push(letters.charAt(Math.floor(Math.random() * letters.length)));
                    for (let i = 0; i < 3; i++) codeParts.push(numbers.charAt(Math.floor(Math.random() * numbers.length)));
                    for (let i = 0; i < 2; i++) codeParts.push(specialChars.charAt(Math.floor(Math.random() * specialChars.length)));
                    for (let i = codeParts.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [codeParts[i], codeParts[j]] = [codeParts[j], codeParts[i]];
                    }
                    const code = codeParts.join('');
                    const expirationDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);

                    const discountData = {
                        nombre: reason,
                        domicilio: 'N/A (QR Especial)',
                        whatsapp: '',
                        codigo: code,
                        valor: parseFloat(value),
                        vencimiento: expirationDate.toISOString(),
                        usageType: isSingleUse ? 'single' : 'multiple',
                        isSpecialQR: true
                    };
                    
                    await this.db.put('descuentos', discountData);
                    await this.loadDescuentos();
                    this.renderDescuentosTable();
                    this.renderDescuentosSelector();

                    const qrContainer = document.getElementById('special-qr-code-container');
                    const qrCard = document.getElementById('special-qr-card');
                    if (!qrContainer || !qrCard) {
                        throw new Error("No se encontraron los contenedores para el QR.");
                    }
                    
                    const qrText = code; // El contenido del QR es el código de descuento
                    
                    qrContainer.innerHTML = '';
                    new window.QRCode(qrContainer, {
                        text: qrText,
                        width: 220,
                        height: 220,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });

                    // Poblar los campos de texto debajo del QR
                    document.getElementById('qr-card-title').textContent = reason;
                    document.getElementById('qr-card-disclaimer').textContent = 'Algunos productos ya incluyen descuento, por lo que no se aplican promociones adicionales.';
                    document.getElementById('qr-card-expiry').textContent = formatQrExpiry(expirationDate.toISOString());

                    qrCard.classList.remove('hidden');
                    // --- MODIFICACIÓN: Se quita el reseteo del formulario de aquí ---
                    showToast('QR de descuento especial generado y guardado.', 'success');

                } catch (error) {
                    console.error("Error generating Special QR Code:", error);
                    showToast('Error al generar el código QR especial.', 'error');
                } finally {
                    this.hideLoading();
                }
            }
            
            // --- FUNCIÓN MODIFICADA ---
            downloadQRCode() {
                const qrContainer = document.getElementById('special-qr-code-container');
                const qrCanvas = qrContainer.querySelector('canvas');
                
                if (!qrCanvas) {
                    showToast('No se encontró el código QR para descargar.', 'error');
                    return;
                }

                // Obtener todos los textos
                const titleText = document.getElementById('qr-card-title').textContent;
                const disclaimerText = document.getElementById('qr-card-disclaimer').textContent;
                const expiryText = document.getElementById('qr-card-expiry').textContent;

                const cardCanvas = document.createElement('canvas');
                const ctx = cardCanvas.getContext('2d');

                // Parámetros de diseño
                const qrSize = 250;
                const padding = 30;
                const spacing = 15;
                const disclaimerMaxWidth = qrSize + 20;

                // Calcular altura del canvas dinámicamente
                ctx.font = 'bold 22px Inter, sans-serif';
                const titleHeight = 25;

                ctx.font = '14px Inter, sans-serif';
                const disclaimerLines = this._wrapText(ctx, disclaimerText, disclaimerMaxWidth);
                const disclaimerHeight = disclaimerLines.length * 18;

                ctx.font = '12px Inter, sans-serif';
                const expiryHeight = 15;
                
                const hrHeight = 10;

                const totalHeight = padding + qrSize + spacing + titleHeight + spacing + disclaimerHeight + hrHeight + expiryHeight + padding;
                const totalWidth = qrSize + (padding * 2);

                cardCanvas.width = totalWidth;
                cardCanvas.height = totalHeight;

                // Empezar a dibujar
                // 1. Fondo blanco
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, cardCanvas.width, cardCanvas.height);

                // 2. Código QR
                ctx.drawImage(qrCanvas, padding, padding, qrSize, qrSize);
                let currentY = padding + qrSize + spacing;

                // 3. Título
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 22px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(titleText, cardCanvas.width / 2, currentY + 20);
                currentY += titleHeight + spacing;
                
                // 4. Disclaimer
                ctx.fillStyle = '#4b5563';
                ctx.font = '14px Inter, sans-serif';
                disclaimerLines.forEach((line, index) => {
                    ctx.fillText(line, cardCanvas.width / 2, currentY + (index * 18));
                });
                currentY += disclaimerHeight + (hrHeight / 2);
                
                // 5. Línea Horizontal
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding + 20, currentY);
                ctx.lineTo(cardCanvas.width - padding - 20, currentY);
                ctx.stroke();
                currentY += (hrHeight / 2) + 5;

                // 6. Fecha de vencimiento
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Inter, sans-serif';
                ctx.fillText(expiryText, cardCanvas.width / 2, currentY + 10);
                
                // Activar la descarga
                const link = document.createElement('a');
                link.download = `QR_Descuento_${titleText.replace(/\s+/g, '_')}.png`;
                link.href = cardCanvas.toDataURL("image/png");
                link.click();
                
                // --- NUEVO: Limpiar la sección después de iniciar la descarga. ---
                this.clearSpecialQRSection();
            }
            
            deleteDescuento(id) {
                openModal({
                    title: "Confirmar Eliminación",
                    body: `¿Estás seguro que deseas eliminar este código de descuento? Esta acción no se puede deshacer.`,
                    confirmText: "Eliminar",
                    confirmStyle: "btn-danger",
                    onConfirm: async () => {
                        this.showLoading();
                        try {
                            await this.db.delete('descuentos', id);
                            await this.loadDescuentos();
                            this.renderDescuentosTable();
                            this.renderDescuentosSelector();
                            closeModal();
                            showToast('Código de descuento eliminado.', 'success');
                        } catch (error) {
                            showToast('Error al eliminar el código.', 'error');
                        } finally {
                            this.hideLoading();
                        }
                    }
                });
            }

            calculateProductPrices() {
                const costo = parseFloat(document.getElementById('producto-costo').value) || 0;
                const porcentaje1 = parseFloat(document.getElementById('producto-porcentaje1').value) || 0;
                const porcentaje2 = parseFloat(document.getElementById('producto-porcentaje2').value) || 0;

                const customRound = (value) => {
                    const remainder = value % 100;
                    if (remainder > 50) {
                        return Math.ceil(value / 100) * 100;
                    } else {
                        return Math.floor(value / 100) * 100;
                    }
                };

                if (costo > 0) {
                    const precio1Calculado = costo * (1 + porcentaje1 / 100);
                    const precio1 = customRound(precio1Calculado);
                    const ganancia1 = precio1 - costo;
                    
                    const precio2Calculado = costo * (1 + porcentaje2 / 100);
                    const precio2 = customRound(precio2Calculado);
                    const ganancia2 = precio2 - costo;

                    const miPago = ganancia1 * (this.config['config-pago-porcentaje'] / 100);

                    document.getElementById('preview-precio1').textContent = formatCurrency(precio1);
                    document.getElementById('preview-ganancia1').textContent = formatCurrency(ganancia1);
                    document.getElementById('preview-precio2').textContent = formatCurrency(precio2);
                    document.getElementById('preview-ganancia2').textContent = formatCurrency(ganancia2);
                    document.getElementById('preview-pago').textContent = formatCurrency(miPago);
                } else {
                    document.getElementById('preview-precio1').textContent = '--';
                    document.getElementById('preview-ganancia1').textContent = '--';
                    document.getElementById('preview-precio2').textContent = '--';
                    document.getElementById('preview-ganancia2').textContent = '--';
                    document.getElementById('preview-pago').textContent = '--';
                }
            }
            
            async saveProducto(e) {
                e.preventDefault();
                this.showLoading();

                const customRound = (value) => {
                    const remainder = value % 100;
                    if (remainder > 50) {
                        return Math.ceil(value / 100) * 100;
                    } else {
                        return Math.floor(value / 100) * 100;
                    }
                };

                const id = document.getElementById('producto-id').value ? parseInt(document.getElementById('producto-id').value) : null;
                const costo = parseFloat(document.getElementById('producto-costo').value);
                const porcentaje1 = parseFloat(document.getElementById('producto-porcentaje1').value);
                const porcentaje2 = parseFloat(document.getElementById('producto-porcentaje2').value);

                const precio1Calculado = costo * (1 + porcentaje1 / 100);
                const precio1 = customRound(precio1Calculado);
                const ganancia1 = precio1 - costo;

                const precio2Calculado = costo * (1 + porcentaje2 / 100);
                const precio2 = customRound(precio2Calculado);
                const ganancia2 = precio2 - costo;
                
                const miPago = ganancia1 * (this.config['config-pago-porcentaje'] / 100);
                const imagenSrc = document.getElementById('productImagePreview').src;
                
                let imagenData = '';
                if (imagenSrc.startsWith('data:image')) {
                    imagenData = imagenSrc;
                } else if (id) {
                    const productoExistente = await this.db.get('productos', id);
                    imagenData = productoExistente.imagen || '';
                }

                const productoData = {
                    nombre: document.getElementById('producto-nombre').value.trim(),
                    categoria: document.getElementById('producto-categoria').value,
                    stock: parseInt(document.getElementById('producto-stock').value),
                    costo: costo,
                    porcentaje1: porcentaje1,
                    porcentaje2: porcentaje2,
                    precio1: precio1,
                    ganancia1: ganancia1,
                    precio2: precio2,
                    ganancia2: ganancia2,
                    miPago: miPago,
                    imagen: imagenData
                };

                if (id) {
                    productoData.id = id;
                }

                try {
                    await this.db.put('productos', productoData);
                    showToast(id ? 'Producto actualizado.' : 'Producto guardado.', 'success');
                    this.clearProductoForm();
                    await this.loadProductos();
                    this.renderStockTable();
                    this.checkLowStock();
                    this.renderComboItemSelector();
                } catch (error) {
                    showToast('Error al guardar el producto.', 'error');
                    console.error("Error saving product:", error);
                } finally {
                    this.hideLoading();
                }
            }

            async editProducto(id) {
                this.switchView('productos');
                const producto = await this.db.get('productos', id);
                if (producto) {
                    document.getElementById('producto-id').value = producto.id;
                    document.getElementById('producto-nombre').value = producto.nombre;
                    document.getElementById('producto-categoria').value = producto.categoria;
                    document.getElementById('producto-stock').value = producto.stock;
                    document.getElementById('producto-costo').value = producto.costo;
                    document.getElementById('producto-porcentaje1').value = producto.porcentaje1;
                    document.getElementById('producto-porcentaje2').value = producto.porcentaje2;
                    document.getElementById('productImagePreview').src = producto.imagen || 'https://placehold.co/150x150/e2e8f0/adb5bd?text=Imagen';
                    
                    document.getElementById('producto-form-title').textContent = 'Editar Artículo';
                    document.getElementById('btn-guardar-producto').textContent = 'Guardar Cambios';
                    document.getElementById('btn-cancelar-edicion').classList.remove('hidden');
                    
                    this.calculateProductPrices();
                    window.scrollTo(0, 0);
                }
            }

            // SOLUCIÓN 1: Nueva función para actualizar el stock de forma instantánea.
            async updateStock(productId, change) {
                try {
                    const producto = this.productos.find(p => p.id === productId);
                    if (!producto) return;

                    const newStock = producto.stock + change;
                    if (newStock < 0) {
                        return; // No hacer nada si el stock se vuelve negativo
                    }
                    
                    producto.stock = newStock;
                    
                    await this.db.put('productos', producto);
                    await this.loadProductos(); // Recargar datos para consistencia
                    
                    this.renderStockTable(); // Volver a dibujar la tabla
                    this.checkLowStock(); // Actualizar la notificación de stock bajo
                    this.renderVentaSelectors(); // Actualizar la disponibilidad en la sección de ventas

                } catch (error) {
                    console.error("Error updating stock:", error);
                    showToast('Error al actualizar el stock.', 'error');
                }
            }

            deleteProducto(id) {
                openModal({
                    title: "Confirmar Eliminación",
                    body: `¿Estás seguro que deseas eliminar este producto? Esta acción no se puede deshacer.`,
                    confirmText: "Eliminar",
                    confirmStyle: "btn-danger",
                    onConfirm: async () => {
                        this.showLoading();
                        try {
                            await this.db.delete('productos', id);
                            await this.loadProductos();
                            this.renderStockTable();
                            this.checkLowStock();
                            this.renderComboItemSelector();
                            closeModal();
                            showToast('Producto eliminado.', 'success');
                        } catch (error) {
                            showToast('Error al eliminar el producto.', 'error');
                        } finally {
                            this.hideLoading();
                        }
                    }
                });
            }

            clearProductoForm() {
                document.getElementById('form-producto').reset();
                document.getElementById('producto-id').value = '';
                document.getElementById('productImagePreview').src = 'https://placehold.co/150x150/e2e8f0/adb5bd?text=Imagen';
                document.getElementById('producto-form-title').textContent = 'Cargar Nuevo Artículo';
                document.getElementById('btn-guardar-producto').textContent = 'Guardar Producto';
                document.getElementById('btn-cancelar-edicion').classList.add('hidden');
                document.getElementById('resultadoCosto').textContent = '';
                this.calculateProductPrices();
            }

            async generateDiscountForNewClient(clientName, clientPhone) {
                try {
                    const discountValue = this.config['config-descuento-compra'];
                    if (!discountValue || discountValue <= 0) {
                        console.log("La generación de descuentos por nuevo cliente está desactivada (valor 0 o no configurado).");
                        return;
                    }

                    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    const numbers = '0123456789';
                    let codeParts = [];
                    for (let i = 0; i < 4; i++) codeParts.push(letters.charAt(Math.floor(Math.random() * letters.length)));
                    for (let i = 0; i < 4; i++) codeParts.push(numbers.charAt(Math.floor(Math.random() * numbers.length)));
                    
                    for (let i = codeParts.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [codeParts[i], codeParts[j]] = [codeParts[j], codeParts[i]];
                    }
                    const code = codeParts.join('');

                    const expirationDate = new Date();
                    expirationDate.setDate(expirationDate.getDate() + 7); // Válido por 7 días

                    const discountData = {
                        nombre: `Bienvenida ${clientName}`,
                        whatsapp: clientPhone,
                        codigo: code,
                        valor: parseFloat(discountValue),
                        vencimiento: expirationDate.toISOString(),
                        usageType: 'single'
                    };
                    
                    await this.db.put('descuentos', discountData);
                    console.log(`Descuento generado para ${clientName}: ${code}`);
                    
                    await this.loadDescuentos();
                    this.renderDescuentosTable();
                    this.renderDescuentosSelector();

                } catch (error) {
                    showToast('Error al generar el código de descuento automático.', 'error');
                    console.error("Error generating automatic discount:", error);
                }
            }
            
            async saveCliente(e) {
                e.preventDefault();
                this.showLoading();
                const id = document.getElementById('cliente-id').value ? parseInt(document.getElementById('cliente-id').value) : null;
                const clienteData = {
                    nombre: document.getElementById('cliente-nombre').value.trim(),
                    telefono: document.getElementById('cliente-telefono').value.trim(),
                    direccion: document.getElementById('cliente-direccion').value.trim(),
                    fechaNacimiento: document.getElementById('cliente-fecha-nacimiento').value,
                };

                if (id) {
                    clienteData.id = id;
                }

                try {
                    await this.db.put('clientes', clienteData);
                    
                    if (!id) {
                        await this.generateDiscountForNewClient(clienteData.nombre, clienteData.telefono);
                        showToast('Cliente guardado y código de descuento generado.', 'success');
                    } else {
                        showToast('Cliente actualizado.', 'success');
                    }

                    this.clearClienteForm();
                    await this.loadClientes();
                    this.renderClientesTable();
                    this.renderClientesSelector();

                } catch (error) {
                    showToast('Error al guardar el cliente.', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            async editCliente(id) {
                const cliente = await this.db.get('clientes', id);
                if (cliente) {
                    document.getElementById('cliente-id').value = cliente.id;
                    document.getElementById('cliente-nombre').value = cliente.nombre;
                    document.getElementById('cliente-telefono').value = cliente.telefono;
                    document.getElementById('cliente-fecha-nacimiento').value = cliente.fechaNacimiento || '';
                    document.getElementById('cliente-direccion').value = cliente.direccion;
                    document.getElementById('cliente-form-title').textContent = 'Editar Cliente';
                    document.getElementById('btn-guardar-cliente').textContent = 'Guardar Cambios';
                    document.getElementById('btn-cancelar-cliente').classList.remove('hidden');
                }
            }

            deleteCliente(id) {
                openModal({
                    title: "Confirmar Eliminación",
                    body: `¿Estás seguro que deseas eliminar a este cliente?`,
                    confirmText: "Eliminar",
                    confirmStyle: "btn-danger",
                    onConfirm: async () => {
                        this.showLoading();
                        try {
                            await this.db.delete('clientes', id);
                            await this.loadClientes();
                            this.renderClientesTable();
                            this.renderClientesSelector();
                            closeModal();
                            showToast('Cliente eliminado.', 'success');
                        } catch (error) {
                            showToast('Error al eliminar el cliente.', 'error');
                        } finally {
                            this.hideLoading();
                        }
                    }
                });
            }

            clearClienteForm() {
                document.getElementById('form-cliente').reset();
                document.getElementById('cliente-id').value = '';
                document.getElementById('cliente-form-title').textContent = 'Cargar Nuevo Cliente';
                document.getElementById('btn-guardar-cliente').textContent = 'Guardar Cliente';
                document.getElementById('btn-cancelar-cliente').classList.add('hidden');
            }

            renderClientesTable() {
                const tbody = document.getElementById('tabla-clientes');
                tbody.innerHTML = '';
                const mensajeWhatsApp = encodeURIComponent('¡Muchas gracias por elegirnos! Tu compra es muy apreciada.🫂 Que lo disfrutes 🍻🍾🥂');
                this.clientes.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
                    const row = tbody.insertRow();
                    
                    const whatsappBtn = c.telefono ?
                        `<a href="https://api.whatsapp.com/send?phone=${c.telefono.replace(/\D/g, '')}&text=${mensajeWhatsApp}" target="_blank" class="text-green-500 hover:text-green-700" title="Enviar WhatsApp"><i class="fab fa-whatsapp"></i></a>` :
                        `<span class="text-gray-400 cursor-not-allowed" title="No hay teléfono registrado"><i class="fab fa-whatsapp"></i></span>`;
                        
                    row.innerHTML = `
                        <td class="p-4">${c.nombre}</td>
                        <td class="p-4">${c.telefono || 'N/A'}</td>
                        <td class="p-4">${c.fechaNacimiento ? formatDate(c.fechaNacimiento) : 'N/A'}</td>
                        <td class="p-4">${c.direccion || 'N/A'}</td>
                        <td class="p-4 flex gap-3 items-center">
                            <button onclick="app.editCliente(${c.id})" class="text-blue-500 hover:text-blue-700" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="app.deleteCliente(${c.id})" class="text-red-500 hover:text-red-700" title="Borrar"><i class="fas fa-trash"></i></button>
                            ${whatsappBtn}
                        </td>
                    `;
                });
            }
            
            async saveCombo(e) {
                e.preventDefault();
                const nombre = document.getElementById('combo-nombre').value.trim();
                const precio = parseFloat(document.getElementById('combo-precio').value);

                if (!nombre || isNaN(precio) || precio <= 0) {
                    showToast('Nombre y precio de venta son obligatorios.', 'error');
                    return;
                }
                if (this.currentComboItems.length === 0) {
                    showToast('Debe agregar al menos un item al combo.', 'error');
                    return;
                }

                this.showLoading();
                const id = document.getElementById('combo-id').value ? parseInt(document.getElementById('combo-id').value) : null;
                
                // SOLUCIÓN: Verificar si ya existe un combo con el mismo nombre antes de intentar guardarlo.
                // Esto previene el error de "Constraint" de la base de datos y da un mensaje más claro al usuario.
                const comboConMismoNombre = this.combos.find(c => c.nombre.toLowerCase() === nombre.toLowerCase());

                if (comboConMismoNombre && comboConMismoNombre.id !== id) {
                    showToast(`Ya existe un combo con el nombre "${nombre}". Por favor, elija otro.`, 'error');
                    this.hideLoading();
                    return; // Detiene la ejecución para evitar el error.
                }

                const imagenSrc = document.getElementById('comboImagePreview').src;
                
                let imagenData = '';
                if (imagenSrc.startsWith('data:image')) {
                    imagenData = imagenSrc;
                } else if (id) {
                    const comboExistenteEnDB = await this.db.get('combos', id);
                    imagenData = comboExistenteEnDB.imagen || '';
                }

                const { costoTotal, gananciaTotal, miPagoTotal } = this.calculateComboTotals(this.currentComboItems, precio);
                
                const comboData = {
                    nombre: nombre,
                    items: this.currentComboItems,
                    precio: precio,
                    costo: costoTotal,
                    ganancia: gananciaTotal,
                    miPago: miPagoTotal,
                    descuentoAplicable: document.getElementById('combo-descuento-aplicable').checked,
                    imagen: imagenData,
                    type: 'combo'
                };

                if (id) {
                    comboData.id = id;
                }

                try {
                    await this.db.put('combos', comboData);
                    showToast(id ? 'Combo actualizado con éxito.' : 'Combo guardado con éxito.', 'success');
                    this.clearComboForm();
                    await this.loadCombos();
                    this.renderCombosList();
                    this.renderVentaSelectors();
                } catch (error) {
                    showToast('Error al guardar el combo.', 'error');
                    console.error("Error saving combo:", error);
                } finally {
                    this.hideLoading();
                }
            }

            async editCombo(id) {
                const combo = await this.db.get('combos', id);
                if (combo) {
                    this.switchView('promociones');
                    document.getElementById('combo-id').value = combo.id;
                    document.getElementById('combo-nombre').value = combo.nombre;
                    document.getElementById('combo-precio').value = combo.precio;
                    document.getElementById('combo-descuento-aplicable').checked = combo.descuentoAplicable;
                    document.getElementById('comboImagePreview').src = combo.imagen || 'https://placehold.co/150x150/e2e8f0/adb5bd?text=Imagen';
                    
                    this.currentComboItems = combo.items || combo.productos; // Legacy support
                    this.renderCurrentComboItems();
                    this.calculateComboPreviews();
                    
                    document.getElementById('combo-form-title').textContent = 'Editar Combo';
                    document.getElementById('btn-guardar-combo').textContent = 'Guardar Cambios';
                    document.getElementById('btn-cancelar-combo').classList.remove('hidden');
                    window.scrollTo(0, 0);
                }
            }

            deleteCombo(id) {
                openModal({
                    title: "Confirmar Eliminación",
                    body: `¿Estás seguro que deseas eliminar este combo? Esta acción no se puede deshacer.`,
                    confirmText: "Eliminar",
                    confirmStyle: "btn-danger",
                    onConfirm: async () => {
                        this.showLoading();
                        try {
                            await this.db.delete('combos', id);
                            await this.loadCombos();
                            this.renderCombosList();
                            this.renderVentaSelectors();
                            closeModal();
                            showToast('Combo eliminado.', 'success');
                        } catch (error) {
                            showToast('Error al eliminar el combo.', 'error');
                        } finally {
                            this.hideLoading();
                        }
                    }
                });
            }

            clearComboForm() {
                document.getElementById('form-combo').reset();
                document.getElementById('combo-id').value = '';
                document.getElementById('comboImagePreview').src = 'https://placehold.co/150x150/e2e8f0/adb5bd?text=Imagen';
                this.currentComboItems = [];
                this.renderCurrentComboItems();
                this.calculateComboPreviews();
                
                document.getElementById('combo-form-title').textContent = 'Cargar Nuevo Combo';
                document.getElementById('btn-guardar-combo').textContent = 'Guardar Combo';
                document.getElementById('btn-cancelar-combo').classList.add('hidden');
            }

            addItemToCurrentCombo() {
                const tipo = document.getElementById('combo-item-tipo').value;
                const selector = document.getElementById('combo-item-selector');
                const itemId = parseInt(selector.value);
                const cantidad = parseFloat(document.getElementById('combo-item-cantidad').value);

                if (!itemId || isNaN(cantidad) || cantidad <= 0) {
                    showToast('Seleccione un item y una cantidad válida.', 'error');
                    return;
                }

                if (tipo === 'Producto') {
                    const producto = this.productos.find(p => p.id === itemId);
                    if (producto) {
                        const existingIndex = this.currentComboItems.findIndex(item => item.type === 'producto' && item.id === itemId);
                        if (existingIndex > -1) {
                            this.currentComboItems[existingIndex].cantidad += cantidad;
                        } else {
                            this.currentComboItems.push({ type: 'producto', id: producto.id, nombre: producto.nombre, costo: producto.costo, cantidad: cantidad });
                        }
                    }
                } else if (tipo === 'Insumo') {
                    const insumo = this.gastos.find(g => g.id === itemId);
                    if (insumo) {
                        if (cantidad > insumo.stockActual) {
                            showToast(`Stock insuficiente para ${insumo.nombreInsumo}. Disponible: ${insumo.stockActual}`, 'error');
                            return;
                        }
                        const valorLote = insumo.valorActual ?? insumo.montoOriginal ?? insumo.monto;
                        const costoUnitario = (insumo.stockOriginal > 0) ? (valorLote / insumo.stockOriginal) : 0;
                        const existingIndex = this.currentComboItems.findIndex(item => item.type === 'insumo' && item.id === itemId);
                        if (existingIndex > -1) {
                            this.currentComboItems[existingIndex].cantidad += cantidad;
                        } else {
                            this.currentComboItems.push({ type: 'insumo', id: insumo.id, nombre: insumo.nombreInsumo, tipoInsumo: insumo.tipo, costoUnitario: costoUnitario, cantidad: cantidad });
                        }
                    }
                }
                
                this.renderCurrentComboItems();
                this.calculateComboPreviews();
            }

            removeItemFromCurrentCombo(index) {
                this.currentComboItems.splice(index, 1);
                this.renderCurrentComboItems();
                this.calculateComboPreviews();
            }

            renderCurrentComboItems() {
                const container = document.getElementById('combo-items-list');
                container.innerHTML = '';
                this.currentComboItems.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md text-sm';
                    const suffix = item.type === 'insumo' ? (item.tipoInsumo === 'Kg' ? 'Kg' : 'u.') : '';
                    div.innerHTML = `
                        <span class="font-medium">${item.cantidad} ${suffix} x ${item.nombre} <em class="text-xs text-gray-500">(${item.type})</em></span>
                        <button type="button" onclick="app.removeItemFromCurrentCombo(${index})" class="text-red-500 hover:text-red-700 font-bold px-2">X</button>
                    `;
                    container.appendChild(div);
                });
            }

            calculateComboPreviews() {
                const precioVenta = parseFloat(document.getElementById('combo-precio').value) || 0;
                const { costoTotal, gananciaTotal, miPagoTotal } = this.calculateComboTotals(this.currentComboItems, precioVenta);
                
                const descuentoPorcentaje = this.config['config-descuento-compra'] || 0;
                // INICIO: MODIFICACIÓN SOLICITADA
                const referenciaDescuento = precioVenta * (descuentoPorcentaje / 100);
                // FIN: MODIFICACIÓN SOLICITADA

                document.getElementById('combo-costo-preview').textContent = formatCurrency(costoTotal);
                document.getElementById('combo-descuento-referencia').textContent = formatCurrency(referenciaDescuento);
                document.getElementById('combo-ganancia-preview').textContent = formatCurrency(gananciaTotal);
                document.getElementById('combo-pago-preview').textContent = formatCurrency(miPagoTotal);
            }

            calculateComboTotals(items, precioVenta) {
                const costoTotal = items.reduce((acc, item) => {
                    let itemCost = 0;
                    if (item.type === 'producto') {
                        itemCost = item.costo * item.cantidad;
                    } else if (item.type === 'insumo') {
                        itemCost = item.costoUnitario * item.cantidad;
                    }
                    return acc + itemCost;
                }, 0);

                const gananciaTotal = precioVenta > 0 ? precioVenta - costoTotal : 0;
                const miPagoTotal = gananciaTotal > 0 ? gananciaTotal * (this.config['config-pago-porcentaje'] / 100) : 0;
                return { costoTotal, gananciaTotal, miPagoTotal };
            }
            
            formatComboItemForDisplay(item, formatType = 'html') {
                if (item.type === 'producto') {
                    const text = `${item.cantidad} x ${item.nombre}`;
                    return formatType === 'html' ? `<li>${text}</li>` : text;
                }
                
                if (item.type === 'insumo') {
                    const insumoDetails = this.gastos.find(g => g.id === item.id);
                    if (!insumoDetails || insumoDetails.ocultarEnCombo) return ''; 

                    let text;
                    if (insumoDetails.ocultarTipoYCantidad) {
                        text = `${insumoDetails.nombreInsumo}`;
                    } else {
                        const suffix = item.tipoInsumo === 'Kg' ? 'Kg' : 'u.';
                        text = `${item.cantidad} ${suffix} x ${item.nombre}`;
                    }
                    return formatType === 'html' ? `<li>${text}</li>` : text;
                }

                const text = `${item.cantidad} x ${item.nombre}`;
                return formatType === 'html' ? `<li>${text}</li>` : text;
            }

            renderCombosList() {
                const container = document.getElementById('lista-combos');
                container.innerHTML = '';
                this.combos.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
                    const card = document.createElement('div');
                    card.className = 'combo-card flex flex-col';
                    const items = c.items || c.productos || [];
                    const itemsHtml = items.map(item => this.formatComboItemForDisplay(item, 'html')).filter(Boolean).join('');
                    
                    const descuentoStar = c.descuentoAplicable ? ' <span class="text-yellow-500" title="Admite descuentos">🌟</span>' : '';

                    // SOLICITUD: Aplicar diseño de Combo responsivo y con jerarquía visual clara
                    card.innerHTML = `
                        <!-- Contenedor principal del contenido del combo, apilado verticalmente. -->
                        <div class="flex-grow flex flex-col">
                            <!-- 1. Contenedor de la Imagen: Responsiva (w-full) y con aspect ratio mantenido (object-cover). -->
                            <div class="w-full mb-3">
                                <img src="${c.imagen || 'https://placehold.co/300x200/e2e8f0/adb5bd?text=Combo'}" alt="${c.nombre}" class="w-full h-40 object-cover rounded-md max-w-full">
                            </div>
                            
                            <!-- Contenedor para Título, Precio y Descripción -->
                            <div class="flex flex-col flex-grow">
                                <!-- 2. Título del Combo -->
                                <h4 class="font-bold text-lg mb-1">${c.nombre}${descuentoStar}</h4>
                                
                                <!-- 3. Precio: Sigue al título. Resaltado con mayor tamaño (text-2xl), negrita y color. -->
                                <p class="font-bold text-2xl text-green-600 mb-3">${formatCurrency(c.precio)}</p>
                                
                                <!-- 4. Descripción (Lista de productos): Adaptable al ancho del contenedor. flex-grow permite que ocupe el espacio sobrante. -->
                                <div class="flex-grow">
                                    <ul class="text-sm text-gray-600 list-disc list-inside">
                                        ${itemsHtml}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Contenedor de botones, empujado al final por el flex-grow del contenedor de contenido. -->
                        <div class="flex justify-between items-center mt-4 pt-3 border-t">
                            <button onclick="app.shareComboOnWhatsApp(${c.id})" class="btn btn-whatsapp flex-grow" title="Compartir en WhatsApp">
                                <i class="fab fa-whatsapp text-lg mr-2"></i>
                                <span>Compartir</span>
                            </button>
                            <div class="flex gap-1 ml-2">
                                <button onclick="app.openLabelGenerator(${c.id})" class="btn btn-image p-2" title="Generar Imagen">
                                    <i class="fas fa-image text-lg"></i>
                                </button>
                                <button onclick="app.editCombo(${c.id})" class="text-blue-500 hover:text-blue-700 text-lg p-2" title="Editar"><i class="fas fa-edit"></i></button>
                                <button onclick="app.deleteCombo(${c.id})" class="text-red-500 hover:text-red-700 text-lg p-2" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            shareComboOnWhatsApp(id) {
                const combo = this.combos.find(c => c.id === id);
                if (!combo) {
                    showToast('No se encontró el combo para compartir.', 'error');
                    return;
                }
                const items = combo.items || combo.productos || [];
                let message = `¡OFERTA ESPECIAL! Combo *${combo.nombre}* a un precio irresistible, *¿te guardo uno?*\n\n`;
                
                const itemsText = items.map(item => this.formatComboItemForDisplay(item, 'text')).filter(Boolean).join('\n');
                if (itemsText) {
                    message += `Incluye:\n${itemsText}\n\n`;
                }

                message += `Precio: ${formatCurrency(combo.precio)}`;

                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }

            renderComboItemSelector() {
                const selector = document.getElementById('combo-item-selector');
                const tipo = document.getElementById('combo-item-tipo').value;
                selector.innerHTML = '<option value="">Seleccione un item...</option>';
                
                if (tipo === 'Producto') {
                    // SOLICITUD: Organizar productos por categoría en el selector de combos
                    const groupedProducts = this.productos.reduce((acc, p) => {
                        const category = p.categoria || 'Sin Categoría';
                        if (!acc[category]) {
                            acc[category] = [];
                        }
                        acc[category].push(p);
                        return acc;
                    }, {});

                    const sortedCategories = Object.keys(groupedProducts).sort((a, b) => a.localeCompare(b));

                    sortedCategories.forEach(category => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = category;
                        
                        const productsInCategory = groupedProducts[category].sort((a, b) => a.nombre.localeCompare(b.nombre));
                        
                        productsInCategory.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.id;
                            option.textContent = p.nombre;
                            optgroup.appendChild(option);
                        });
                        selector.appendChild(optgroup);
                    });

                } else if (tipo === 'Insumo') {
                    const insumos = this.gastos.filter(g => g.nombreInsumo && g.stockActual > 0);
                    insumos.sort((a,b) => a.nombreInsumo.localeCompare(b.nombreInsumo)).forEach(i => {
                        selector.innerHTML += `<option value="${i.id}">${i.nombreInsumo} (${i.stockActual} ${i.tipo})</option>`;
                    });
                }
            }

            renderClientesSelector() {
                const selector = document.getElementById('venta-cliente');
                selector.innerHTML = '<option value="">Cliente Ocasional</option>';
                this.clientes.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(c => {
                    selector.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });
            }
            
            renderDescuentosSelector() {
                 const selector = document.getElementById('venta-descuento-selector');
                 selector.innerHTML = '<option value="">Sin Descuento</option>';
                 const now = new Date();
                 this.descuentos
                    .filter(d => new Date(d.vencimiento) > now)
                    .sort((a,b) => a.nombre.localeCompare(b.nombre))
                    .forEach(d => {
                        selector.innerHTML += `<option value="${d.id}">${d.codigo} - ${d.nombre} (${d.valor}%)</option>`;
                 });
            }

            renderVentaSelectors() {
                const typeSelector = document.getElementById('venta-tipo-item');
                const itemSelector = document.getElementById('venta-item-selector');
                const priceContainer = document.getElementById('venta-precio-container');
                const selectedType = typeSelector.value;

                itemSelector.innerHTML = '<option value="">Seleccione un artículo...</option>';

                if (selectedType === 'productos') {
                    priceContainer.style.display = 'block';
                    
                    // SOLUCIÓN: Agrupar productos por categoría
                    const groupedProducts = this.productos.reduce((acc, p) => {
                        if (p.stock > 0) {
                            const category = p.categoria || 'Sin Categoría';
                            if (!acc[category]) {
                                acc[category] = [];
                            }
                            acc[category].push(p);
                        }
                        return acc;
                    }, {});

                    const sortedCategories = Object.keys(groupedProducts).sort((a, b) => a.localeCompare(b));

                    sortedCategories.forEach(category => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = category;

                        const productsInCategory = groupedProducts[category].sort((a, b) => a.nombre.localeCompare(b.nombre));
                        
                        productsInCategory.forEach(p => {
                            const option = document.createElement('option');
                            option.value = `prod-${p.id}`;
                            option.textContent = `${p.nombre} (Stock: ${p.stock})`;
                            optgroup.appendChild(option);
                        });
                        
                        itemSelector.appendChild(optgroup);
                    });

                } else if (selectedType === 'combos') {
                    priceContainer.style.display = 'none';
                    const combosOrdenados = [...this.combos].sort((a, b) => a.nombre.localeCompare(b.nombre));
                    combosOrdenados.forEach(c => {
                        const items = c.items || c.productos || [];
                        const hasStock = items.every(item => {
                            if (item.type === 'producto') {
                                const producto = this.productos.find(p => p.id === item.id);
                                return producto && producto.stock >= item.cantidad;
                            } else if (item.type === 'insumo') {
                                const insumo = this.gastos.find(g => g.id === item.id);
                                return insumo && insumo.stockActual >= item.cantidad;
                            }
                            const producto = this.productos.find(p => p.id === item.id);
                            return producto && producto.stock >= item.cantidad;
                        });
                        
                        if (hasStock) {
                            itemSelector.innerHTML += `<option value="combo-${c.id}">${c.nombre}</option>`;
                        }
                    });
                }
            }
            
            generatePriceListPDF() {
                this.showLoading();
                try {
                    const { jsPDF } = window.jspdf;
                    if (typeof jsPDF === 'undefined' || typeof jsPDF.API.autoTable === 'undefined') {
                        throw new Error("La librería jsPDF o jsPDF-AutoTable no se cargó correctamente.");
                    }
                    const doc = new jsPDF();
                    let finalY = 15;
                    const pageCenter = doc.internal.pageSize.getWidth() / 2;

                    // Header
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text("PER & PIE Bebidas - Lista de Precios", pageCenter, finalY, { align: 'center' });
                    finalY += 8;

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text("WhatsApp 342 5993971 / 3483 483892", pageCenter, finalY, { align: 'center' });
                    finalY += 5;
                    doc.text("Solo Ventas En Línea, se retira por E. Zeballos 4327 P.A. Santa Fe, Capital", pageCenter, finalY, { align: 'center' });
                    finalY += 7;

                    doc.setFontSize(9);
                    doc.setTextColor(100);
                    doc.text(`Generado el: ${new Date().toLocaleString('es-AR')}`, pageCenter, finalY, { align: 'center' });
                    finalY += 10;

                    const groupedProducts = this.productos.reduce((acc, p) => {
                        const category = p.categoria || 'Sin Categoría';
                        if (!acc[category]) { acc[category] = []; }
                        acc[category].push(p);
                        return acc;
                    }, {});
                    const sortedCategories = ['Fernet', 'Gaseosas y Aguas', 'Aperitivos', 'Vinos', 'Cervezas', 'Licores y Destilados', 'Espumantes', 'Otros'].filter(c => groupedProducts[c]);

                    sortedCategories.forEach(category => {
                        const productsInCategory = groupedProducts[category]
                            .sort((a, b) => a.nombre.localeCompare(b.nombre));

                        // MEJORA SOLICITADA: Lógica para "Sin Stock"
                        const tableBody = productsInCategory.map(p => [
                            p.nombre,
                            'Unidad',
                            p.stock > 0 ? formatCurrency(p.precio1) : 'Sin Stock'
                        ]);
                        
                        if (tableBody.length > 0) {
                             doc.autoTable({
                                startY: finalY,
                                head: [
                                    [{ content: category, colSpan: 3, styles: { halign: 'center', fillColor: [52, 73, 94], textColor: 255, fontStyle: 'bold', fontSize: 14 } }],
                                    ['Producto', 'Presentación', 'Precio']
                                ],
                                body: tableBody,
                                theme: 'grid',
                                headStyles: {
                                    fillColor: [230, 230, 230],
                                    textColor: 40,
                                    fontStyle: 'bold',
                                    halign: 'center'
                                },
                                didParseCell: function (data) {
                                    if (data.section === 'body') {
                                        // Columna 'Presentación'
                                        if (data.column.index === 1) {
                                            data.cell.styles.halign = 'center';
                                        }
                                        // Columna 'Precio'
                                        if (data.column.index === 2) {
                                            // MEJORA SOLICITADA: Estilo condicional para "Sin Stock"
                                            if (data.cell.raw === 'Sin Stock') {
                                                data.cell.styles.halign = 'center';
                                                data.cell.styles.textColor = [220, 53, 69]; // Color rojo
                                                data.cell.styles.fontStyle = 'bold';
                                            } else {
                                                data.cell.styles.halign = 'right';
                                                data.cell.styles.fontStyle = 'bold';
                                            }
                                        }
                                    }
                                }
                            });
                            finalY = doc.lastAutoTable.finalY + 10;
                        }
                    });

                    doc.save('PER&PIE-Lista_De_Precios.pdf');
                } catch (error) {
                    console.error("Error al generar el PDF:", error);
                    showToast('Error al generar el PDF. Verifique su conexión a internet.', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            handleAddItemToCart() {
                const itemSelector = document.getElementById('venta-item-selector');
                const selectedValue = itemSelector.value;
                const cantidad = parseInt(document.getElementById('venta-item-cantidad').value);

                if (!selectedValue || isNaN(cantidad) || cantidad <= 0) {
                    showToast('Seleccione un artículo y cantidad válida.', 'error');
                    return;
                }

                const [type, idStr] = selectedValue.split('-');
                const id = parseInt(idStr);
                let itemToAdd = null;

                if (type === 'prod') {
                    const producto = this.productos.find(p => p.id === id);
                    if (!producto) return;
                    
                    const existingInCart = this.carrito.find(item => item.type === 'prod' && item.id === id);
                    const currentQtyInCart = existingInCart ? existingInCart.cantidad : 0;
                    if (producto.stock < cantidad + currentQtyInCart) {
                        showToast(`Stock insuficiente para "${producto.nombre}". Disponible: ${producto.stock}`, 'error');
                        return;
                    }

                    const priceSelector = document.getElementById('venta-precio-selector');
                    const unitPrice = priceSelector.value === '1' ? producto.precio1 : producto.precio2;
                    const ganancia = priceSelector.value === '1' ? producto.ganancia1 : producto.ganancia2;
                    const miPago = priceSelector.value === '1' ? producto.miPago : (producto.ganancia2 * (this.config['config-pago-porcentaje'] / 100));

                    itemToAdd = {
                        id: producto.id,
                        nombre: producto.nombre,
                        type: 'prod',
                        cantidad,
                        precioUnitario: unitPrice,
                        gananciaUnitaria: ganancia,
                        miPagoUnitario: miPago,
                    };
                } else if (type === 'combo') {
                    const combo = this.combos.find(c => c.id === id);
                    if (!combo) return;

                    const items = combo.items || combo.productos || [];
                    for (const item of items) {
                        const requiredQty = item.cantidad * cantidad;
                        if(item.type === 'producto') {
                            const producto = this.productos.find(p => p.id === item.id);
                            if (!producto || producto.stock < requiredQty) {
                                showToast(`Stock insuficiente para "${item.nombre}" en el combo.`, 'error');
                                return;
                            }
                        } else if(item.type === 'insumo') {
                            const insumo = this.gastos.find(g => g.id === item.id);
                            if(!insumo || insumo.stockActual < requiredQty) {
                                showToast(`Stock insuficiente para el insumo "${item.nombre}" en el combo.`, 'error');
                                return;
                            }
                        }
                    }

                    itemToAdd = {
                        id: combo.id,
                        nombre: combo.nombre,
                        type: 'combo',
                        items: items,
                        cantidad,
                        precioUnitario: combo.precio,
                        gananciaUnitaria: combo.ganancia,
                        miPagoUnitario: combo.miPago,
                    };
                }

                if (itemToAdd) {
                    const cartIndex = this.carrito.findIndex(item => item.id === itemToAdd.id && item.type === itemToAdd.type && (item.type === 'combo' || item.precioUnitario === itemToAdd.precioUnitario));
                    if (cartIndex > -1) {
                        this.carrito[cartIndex].cantidad += cantidad;
                    } else {
                        this.carrito.push(itemToAdd);
                    }
                    this.renderCarrito();
                    this.calcularTotalesVenta();
                    showToast('Item agregado al carrito.', 'success');
                }
            }

            renderCarrito() {
                const tbody = document.getElementById('tabla-carrito');
                tbody.innerHTML = '';
                if (this.carrito.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">El carrito está vacío</td></tr>';
                    return;
                }

                this.carrito.forEach((item, index) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="p-2">${item.nombre}</td>
                        <td class="p-2">${formatCurrency(item.precioUnitario)}</td>
                        <td class="p-2">${item.cantidad}</td>
                        <td class="p-2 font-bold">${formatCurrency(item.precioUnitario * item.cantidad)}</td>
                        <td class="p-2">
                            <button onclick="app.removeFromCart(${index})" class="text-red-500 hover:text-red-700" title="Quitar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });
            }

            removeFromCart(index) {
                this.carrito.splice(index, 1);
                this.renderCarrito();
                this.calcularTotalesVenta();
            }

            calcularTotalesVenta() {
                const subtotal = this.carrito.reduce((acc, item) => acc + (item.precioUnitario * item.cantidad), 0);
                
                let montoDescuento = 0;
                const descuentoSelector = document.getElementById('venta-descuento-selector');
                const selectedDiscountId = descuentoSelector.value;

                if (selectedDiscountId) {
                    const descuento = this.descuentos.find(d => d.id === parseInt(selectedDiscountId));
                    if (descuento) {
                        const subtotalDescontable = this.carrito.reduce((acc, item) => {
                            let esAplicable = false;
                            if (item.type === 'prod') {
                                esAplicable = true;
                            } else if (item.type === 'combo') {
                                const comboInfo = this.combos.find(c => c.id === item.id);
                                esAplicable = comboInfo ? comboInfo.descuentoAplicable : false;
                            }
                            
                            if (esAplicable) {
                                return acc + (item.precioUnitario * item.cantidad);
                            }
                            return acc;
                        }, 0);
                        
                        montoDescuento = subtotalDescontable * (descuento.valor / 100);
                    }
                }
                
                const total = subtotal - montoDescuento;

                document.getElementById('venta-subtotal').textContent = formatCurrency(subtotal);
                document.getElementById('venta-monto-descuento').textContent = formatCurrency(montoDescuento);
                document.getElementById('venta-total').textContent = formatCurrency(total);
                
                document.getElementById('btn-guardar-venta').disabled = this.carrito.length === 0;
            }

            limpiarVentaCompleta() {
                this.carrito = [];
                document.getElementById('form-venta').reset();
                this.renderCarrito();
                this.calcularTotalesVenta();
                showToast('Venta limpiada.', 'success');
            }

            async saveVenta(e) {
                e.preventDefault();
                if (this.carrito.length === 0) {
                    showToast('El carrito está vacío.', 'error');
                    return;
                }

                this.showLoading();
                try {
                    const subtotal = this.carrito.reduce((acc, item) => acc + (item.precioUnitario * item.cantidad), 0);
                    const descuentoId = document.getElementById('venta-descuento-selector').value;
                    let montoDescuento = 0;
                    let descuentoAplicado = null; 

                    if (descuentoId) {
                        const descuento = this.descuentos.find(d => d.id === parseInt(descuentoId));
                        if(descuento) {
                             const subtotalDescontable = this.carrito.reduce((acc, item) => {
                                let esAplicable = false;
                                if (item.type === 'prod') {
                                    esAplicable = true;
                                } else if (item.type === 'combo') {
                                    const comboInfo = this.combos.find(c => c.id === item.id);
                                    esAplicable = comboInfo ? comboInfo.descuentoAplicable : false;
                                }
                                if (esAplicable) {
                                    return acc + (item.precioUnitario * item.cantidad);
                                }
                                return acc;
                            }, 0);
                            montoDescuento = subtotalDescontable * (descuento.valor / 100);
                            descuentoAplicado = { ...descuento };
                        }
                    }

                    const total = subtotal - montoDescuento;

                    const costoTotal = this.carrito.reduce((acc, cartItem) => {
                        let itemCost = 0;
                        if (cartItem.type === 'prod') {
                            const producto = this.productos.find(p => p.id === cartItem.id);
                            if (producto) {
                                itemCost = producto.costo * cartItem.cantidad;
                            }
                        } else if (cartItem.type === 'combo') {
                            const combo = this.combos.find(c => c.id === cartItem.id);
                            if (combo) {
                                itemCost = combo.costo * cartItem.cantidad;
                            }
                        }
                        return acc + itemCost;
                    }, 0);

                    const gananciaTotal = total - costoTotal;
                    const miPagoTotal = gananciaTotal * (this.config['config-pago-porcentaje'] / 100);

                    const ventaData = {
                        fecha: new Date().toISOString(),
                        items: this.carrito,
                        clienteId: document.getElementById('venta-cliente').value ? parseInt(document.getElementById('venta-cliente').value) : null,
                        descuentoId: descuentoId ? parseInt(descuentoId) : null,
                        descuentoAplicado: descuentoAplicado,
                        formaDePago: document.getElementById('venta-forma-pago').value,
                        subtotal: subtotal,
                        montoDescuento: montoDescuento,
                        total: total,
                        ganancia: gananciaTotal,
                        miPago: miPagoTotal
                    };
                    
                    for (const cartItem of this.carrito) {
                        if (cartItem.type === 'prod') {
                            const producto = this.productos.find(p => p.id === cartItem.id);
                            if (producto) {
                                producto.stock -= cartItem.cantidad;
                                await this.db.put('productos', producto);
                            }
                        } else if (cartItem.type === 'combo') {
                            for (const comboItem of cartItem.items) {
                                const qtyToDeduct = comboItem.cantidad * cartItem.cantidad;
                                if (comboItem.type === 'producto') {
                                    const producto = this.productos.find(p => p.id === comboItem.id);
                                    if(producto) {
                                        producto.stock -= qtyToDeduct;
                                        await this.db.put('productos', producto);
                                    }
                                } else if (comboItem.type === 'insumo') {
                                    const insumo = this.gastos.find(g => g.id === comboItem.id);
                                    if(insumo) {
                                        insumo.stockActual -= qtyToDeduct;
                                        await this.db.put('gastos', insumo);
                                    }
                                }
                            }
                        }
                    }
                    
                    await this.db.put('ventas', ventaData);

                    if (descuentoId) {
                        const discountUsed = this.descuentos.find(d => d.id === parseInt(descuentoId));
                        if (discountUsed && discountUsed.usageType === 'single') {
                            await this.db.delete('descuentos', parseInt(descuentoId));
                            showToast('Venta registrada y código de un solo uso consumido.', 'success');
                        } else {
                            showToast('Venta registrada con éxito.', 'success');
                        }
                    } else {
                        showToast('Venta registrada con éxito.', 'success');
                    }
                    
                    this.limpiarVentaCompleta();
                    await this.loadAllData();
                    
                } catch (error) {
                    console.error("Error al registrar la venta:", error);
                    showToast('Error al registrar la venta.', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            renderVentasTable() {
                const tbody = document.getElementById('tabla-ventas');
                tbody.innerHTML = '';
                const ventasOrdenadas = [...this.ventas]
                    .filter(v => !v.archivada)
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                ventasOrdenadas.forEach(v => {
                    const row = tbody.insertRow();
                    const cliente = v.clienteId ? this.clientes.find(c => c.id === v.clienteId) : null;
                    row.innerHTML = `
                        <td class="p-4">${new Date(v.fecha).toLocaleString('es-AR')}</td>
                        <td class="p-4">${cliente ? cliente.nombre : 'Cliente Ocasional'}</td>
                        <td class="p-4">${v.formaDePago || 'N/A'}</td>
                        <td class="p-4 font-bold">${formatCurrency(v.total)}</td>
                        <td class="p-4 text-green-600">${formatCurrency(v.ganancia || 0)}</td>
                        <td class="p-4 flex gap-3 items-center">
                            <button onclick="app.verDetalleVenta(${v.id})" class="text-blue-500 hover:text-blue-700" title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="app.deleteVenta(${v.id})" class="text-red-500 hover:text-red-700" title="Eliminar/Revertir Venta">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button onclick="app.sendWhatsAppMessage(${v.id})" class="text-green-500 hover:text-green-700" title="Enviar por WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        </td>
                    `;
                });
            }

            async verDetalleVenta(id) {
                const venta = this.ventas.find(v => v.id === id);
                if (!venta) return;

                const cliente = venta.clienteId ? this.clientes.find(c => c.id === venta.clienteId) : null;
                
                let itemsHtml = '<table class="w-full text-left text-sm mt-2">';
                venta.items.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td class="py-1 pr-2">${item.cantidad} x ${item.nombre}</td>
                            <td class="py-1 text-right">${formatCurrency(item.precioUnitario * item.cantidad)}</td>
                        </tr>
                    `;
                });
                itemsHtml += '</table>';

                const headerHtml = `
                    <div class="text-center">
                        <h4 class="text-xl font-bold">PER & PIE Bebidas</h4>
                        <p class="text-sm">WhatsApp: 342 5993971 / 3483 483892</p>
                        <p class="text-sm">E. Zeballos 4327 P.A. Santa Fe, Capital</p>
                        <p class="text-xs font-mono mt-1">- - - Solo Venta en Línea - - -</p>
                    </div>
                `;

                const bodyContent = `
                    ${headerHtml}
                    <hr class="my-3 border-dashed">
                    <div class="text-sm">
                        <p><strong>Fecha:</strong> ${new Date(venta.fecha).toLocaleString('es-AR')}</p>
                        <p><strong>Cliente:</strong> ${cliente ? cliente.nombre : 'Cliente Ocasional'}</p>
                        <p><strong>Forma de Pago:</strong> ${venta.formaDePago || 'N/A'}</p>
                    </div>
                    <div class="my-3">
                        ${itemsHtml}
                    </div>
                    <hr class="my-3 border-dashed">
                    <div class="text-right text-sm">
                        <p>Subtotal: <strong>${formatCurrency(venta.subtotal)}</strong></p>
                        ${venta.montoDescuento > 0 ? `<p>Descuento: <strong>-${formatCurrency(venta.montoDescuento)}</strong></p>` : ''}
                        <p class="font-bold text-lg mt-1">TOTAL: <strong>${formatCurrency(venta.total)}</strong></p>
                    </div>
                `;

                openModal({
                    title: '',
                    body: bodyContent,
                    confirmText: "Cerrar",
                    onConfirm: closeModal
                });
                
                const footer = document.getElementById('modal-footer');
                const pdfButton = document.createElement('button');
                pdfButton.id = 'modal-pdf-btn';
                pdfButton.className = 'btn btn-secondary';
                pdfButton.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Descargar PDF';
                pdfButton.onclick = () => this.generateTicketPDF(id);
                
                const confirmButton = document.getElementById('modal-confirm-btn');
                footer.insertBefore(pdfButton, confirmButton);
                
                const cancelButton = document.getElementById('modal-cancel-btn');
                if (cancelButton) {
                    cancelButton.style.display = 'none';
                }
            }

            openPaymentStatusModal(onResolve) {
                const modal = document.getElementById('generic-modal');
                document.getElementById('modal-title').textContent = '¿El pedido se encuentra pago?';
                document.getElementById('modal-body').innerHTML = '<p>Seleccione el estado del pago para incluirlo en el mensaje de WhatsApp.</p>';
                
                const footer = document.getElementById('modal-footer');
                footer.innerHTML = `
                    <button id="modal-btn-no" class="btn btn-danger">NO</button>
                    <button id="modal-btn-si" class="btn btn-secondary">SI</button>
                `;

                document.getElementById('modal-btn-no').addEventListener('click', () => {
                    closeModal();
                    onResolve(false);
                }, { once: true });

                document.getElementById('modal-btn-si').addEventListener('click', () => {
                    closeModal();
                    onResolve(true);
                }, { once: true });

                modal.classList.add('active');
            }

            sendWhatsAppMessage(ventaId) {
                const venta = this.ventas.find(v => v.id === ventaId);
                if (!venta) {
                    showToast('Venta no encontrada.', 'error');
                    return;
                }

                const empleadoWhatsapp = this.config['config-whatsapp-empleado']?.replace(/\D/g, '');
                if (!empleadoWhatsapp) {
                    showToast('El número de WhatsApp del empleado no está configurado.', 'error');
                    this.switchView('configuracion');
                    return;
                }

                this.openPaymentStatusModal(isPaid => {
                    const paymentStatus = isPaid ? '*YA FUE PAGADO*' : '*DEBE PAGAR*';
                    
                    const cliente = venta.clienteId ? this.clientes.find(c => c.id === venta.clienteId) : null;
                    const clienteNombre = cliente ? cliente.nombre : 'Cliente Ocasional';
                    const clienteDomicilio = cliente && cliente.direccion ? cliente.direccion : 'No especificado';
                    
                    const fechaVenta = new Date(venta.fecha).toLocaleString('es-AR', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                    
                    const formaPago = venta.formaDePago || 'N/A';

                    let itemsList = '';
                    venta.items.forEach(item => {
                        if (item.type === 'prod') {
                            itemsList += `${item.cantidad} X ${item.nombre}\n`;
                        } else if (item.type === 'combo') {
                            itemsList += `${item.cantidad} X ${item.nombre.toUpperCase()}\n`;
                            const comboItems = item.items || [];
                            if (comboItems.length > 0) {
                                const subItemsText = comboItems
                                    .map(p => this.formatComboItemForDisplay(p, 'text'))
                                    .filter(Boolean)
                                    .map(text => `   ● ${text}`)
                                    .join('\n');
                                if (subItemsText) {
                                    itemsList += subItemsText + '\n';
                                }
                            }
                        }
                    });

                    const message = `${paymentStatus}
...........................................................................
Fecha: ${fechaVenta}
Cliente: ${clienteNombre}
Domicilio: ${clienteDomicilio}
Forma de pago: ${formaPago}
---------------------------------------------------------------------------
Items:
${itemsList.trim()}
---------------------------------------------------------------------------
*Total de la compra: ${formatCurrency(venta.total)}*`;

                    const whatsappUrl = `https://api.whatsapp.com/send?phone=${empleadoWhatsapp}&text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                });
            }

            deleteVenta(id) {
                const bodyContent = `
                    <p class="text-sm mb-4">
                        <b>Revertir Venta:</b> Esto restaurará el stock, anulará la ganancia/pago de esta venta y reactivará el código de descuento que se haya usado.
                    </p>
                    <p class="text-sm mb-4">
                        <b>Archivar Venta:</b> Si no se revierte, la venta solo será archivada (ocultada) del historial, pero las métricas y el stock no cambiarán.
                    </p>
                    <div class="mt-4 p-3 bg-gray-100 rounded-md">
                        <div class="flex items-center">
                            <input type="checkbox" id="revertir-venta-checkbox" class="h-5 w-5 rounded border-gray-300 text-red-600 focus:ring-red-500">
                            <label for="revertir-venta-checkbox" class="ml-3 block font-medium text-gray-800">Confirmar Reversión Completa</label>
                        </div>
                    </div>
                `;

                openModal({
                    title: '<span class="text-red-600">Revertir Venta Completa</span>',
                    body: bodyContent,
                    confirmText: "Aplicar",
                    confirmStyle: "btn-primary",
                    onConfirm: async () => {
                        const revertir = document.getElementById('revertir-venta-checkbox').checked;
                        this.showLoading();
                        try {
                            const venta = await this.db.get('ventas', id);
                            if (!venta) throw new Error("Venta no encontrada");

                            if (revertir) {
                                for (const cartItem of venta.items) {
                                    if (cartItem.type === 'prod') {
                                        const producto = this.productos.find(p => p.id === cartItem.id);
                                        if (producto) {
                                            producto.stock += cartItem.cantidad;
                                            await this.db.put('productos', producto);
                                        }
                                    } else if (cartItem.type === 'combo') {
                                        const comboItems = cartItem.items || [];
                                        for (const comboItem of comboItems) {
                                            const qtyToRestore = comboItem.cantidad * cartItem.cantidad;
                                            if (comboItem.type === 'producto' || !comboItem.type) {
                                                const producto = this.productos.find(p => p.id === comboItem.id);
                                                if (producto) {
                                                    producto.stock += qtyToRestore;
                                                    await this.db.put('productos', producto);
                                                }
                                            } else if (comboItem.type === 'insumo') {
                                                const insumo = this.gastos.find(g => g.id === comboItem.id);
                                                if (insumo) {
                                                    insumo.stockActual += qtyToRestore;
                                                    await this.db.put('gastos', insumo);
                                                }
                                            }
                                        }
                                    }
                                }

                                if (venta.descuentoAplicado) {
                                    const discountToRestore = { ...venta.descuentoAplicado };
                                    delete discountToRestore.id;
                                    await this.db.put('descuentos', discountToRestore);
                                }
                                
                                await this.db.delete('ventas', id);
                                showToast('Venta revertida y stock restaurado.', 'success');
                            } else {
                                venta.archivada = true;
                                await this.db.put('ventas', venta);
                                showToast('Venta archivada.', 'success');
                            }
                            
                            await this.loadAllData();
                            closeModal();
                        } catch(error) {
                            showToast('Error al procesar la venta.', 'error');
                            console.error("Error processing sale:", error);
                        } finally {
                            this.hideLoading();
                        }
                    }
                });
            }
            
            async generateTicketPDF(id) {
                const venta = this.ventas.find(v => v.id === id);
                if (!venta) {
                    showToast('Venta no encontrada para generar PDF.', 'error');
                    return;
                }

                this.showLoading();
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [80, 297] });

                    const cliente = venta.clienteId ? this.clientes.find(c => c.id === venta.clienteId) : null;
                    
                    let y = 10;
                    const margin = 5;
                    const maxWidth = 80 - margin * 2;

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text("PER & PIE Bebidas", 40, y, { align: 'center' });
                    y += 6;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text("WhatsApp: 342 5993971 / 3483 483892", 40, y, { align: 'center' });
                    y += 4;
                    doc.text("E. Zeballos 4327 P.A. Santa Fe, Capital", 40, y, { align: 'center' });
                    y += 4;
                    doc.setFont('courier', 'normal');
                    doc.text("- - - Solo Venta en Línea - - -", 40, y, { align: 'center' });
                    y += 6;

                    doc.setLineDash([0.5, 0.5], 0);
                    doc.line(margin, y, 80 - margin, y);
                    y += 5;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`Fecha: ${new Date(venta.fecha).toLocaleString('es-AR')}`, margin, y);
                    y += 5;
                    doc.text(`Cliente: ${cliente ? cliente.nombre : 'Cliente Ocasional'}`, margin, y);
                    y += 5;
                    doc.text(`Forma de Pago: ${venta.formaDePago || 'N/A'}`, margin, y);
                    y += 6;

                    doc.setFont('helvetica', 'bold');
                    doc.text("Cant. x Producto", margin, y);
                    doc.text("Total", 80 - margin, y, { align: 'right' });
                    y += 2;
                    doc.line(margin, y, 80 - margin, y);
                    y += 4;

                    doc.setFont('helvetica', 'normal');
                    venta.items.forEach(item => {
                        const itemTotal = formatCurrency(item.precioUnitario * item.cantidad);
                        const itemName = `${item.cantidad} x ${item.nombre}`;
                        const itemNameLines = doc.splitTextToSize(itemName, maxWidth - 20);

                        doc.text(itemNameLines, margin, y);
                        doc.text(itemTotal, 80 - margin, y, { align: 'right' });
                        
                        const lineHeight = 4;
                        y += (itemNameLines.length * lineHeight) + 2; 

                        if (y > 280) {
                            doc.addPage();
                            y = 10;
                        }
                    });
                    y += 2;

                    doc.line(margin, y, 80 - margin, y);
                    y += 5;
                    
                    const labelX = margin;
                    const valueX = 80 - margin;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text("Subtotal:", labelX, y);
                    doc.text(formatCurrency(venta.subtotal), valueX, y, { align: 'right' });
                    y += 6;

                    if (venta.montoDescuento > 0) {
                         doc.text("Descuento:", labelX, y);
                         doc.text(`-${formatCurrency(venta.montoDescuento)}`, valueX, y, { align: 'right' });
                         y += 6;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text("TOTAL:", labelX, y);
                    doc.text(formatCurrency(venta.total), valueX, y, { align: 'right' });
                    y += 10;
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'italic');
                    doc.text("¡Gracias por su compra!", 40, y, { align: 'center' });

                    doc.save(`ticket-perypie-${venta.id}.pdf`);

                } catch (error) {
                    console.error("Error al generar PDF:", error);
                    showToast('Error al generar el PDF.', 'error');
                } finally {
                    this.hideLoading();
                }
            }
            
            attachListeners() {
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.addEventListener('click', (e) => this.switchView(e.currentTarget.getAttribute('data-view')));
                });
                document.getElementById('menu-toggle-btn').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('active');
                });
                
                document.getElementById('form-producto').addEventListener('submit', this.saveProducto.bind(this));
                document.getElementById('form-cliente').addEventListener('submit', this.saveCliente.bind(this));
                document.getElementById('form-venta').addEventListener('submit', this.saveVenta.bind(this));
                document.getElementById('form-config').addEventListener('submit', this.saveConfig.bind(this));
                document.getElementById('form-gasto').addEventListener('submit', this.saveGasto.bind(this));
                document.getElementById('form-gasto-rapido').addEventListener('submit', this.saveGastoRapido.bind(this));
                document.getElementById('btn-cancelar-gasto').addEventListener('click', this.clearGastoForm.bind(this));
                document.getElementById('form-descuento-especial').addEventListener('submit', this.generateSpecialQRCode.bind(this));
                document.getElementById('btn-download-qr').addEventListener('click', this.downloadQRCode.bind(this));

                // MODIFICACIÓN: Listeners para checkboxes de tipo de uso de descuento
                const singleUseCb = document.getElementById('special-discount-single-use');
                const multipleUseCb = document.getElementById('special-discount-multiple-use');

                singleUseCb.addEventListener('change', () => {
                    if (singleUseCb.checked) {
                        multipleUseCb.checked = false;
                    }
                });

                multipleUseCb.addEventListener('change', () => {
                    if (multipleUseCb.checked) {
                        singleUseCb.checked = false;
                    }
                });
                
                document.getElementById('venta-tipo-item').addEventListener('change', this.renderVentaSelectors.bind(this));
                document.getElementById('btn-agregar-item-venta').addEventListener('click', this.handleAddItemToCart.bind(this));
                document.getElementById('btn-limpiar-venta-completa').addEventListener('click', this.limpiarVentaCompleta.bind(this));
                document.getElementById('venta-descuento-selector').addEventListener('change', this.calcularTotalesVenta.bind(this));

                const productPriceInputs = ['producto-costo', 'producto-porcentaje1', 'producto-porcentaje2'];
                productPriceInputs.forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.calculateProductPrices());
                });
                document.getElementById('config-pago-porcentaje').addEventListener('input', () => this.calculateProductPrices());
                document.getElementById('btn-cancelar-edicion').addEventListener('click', this.clearProductoForm.bind(this));
                document.getElementById('producto-imagen').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('productImagePreview').src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                document.getElementById('btn-cancelar-cliente').addEventListener('click', this.clearClienteForm.bind(this));

                document.getElementById('form-combo').addEventListener('submit', this.saveCombo.bind(this));
                document.getElementById('btn-agregar-item-combo').addEventListener('click', this.addItemToCurrentCombo.bind(this));
                document.getElementById('combo-precio').addEventListener('input', this.calculateComboPreviews.bind(this));
                document.getElementById('btn-cancelar-combo').addEventListener('click', this.clearComboForm.bind(this));
                document.getElementById('combo-item-tipo').addEventListener('change', this.renderComboItemSelector.bind(this));

                document.getElementById('combo-imagen').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('comboImagePreview').src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                document.getElementById('btn-generate-pdf').addEventListener('click', this.generatePriceListPDF.bind(this));
                document.getElementById('btn-reset-data').addEventListener('click', this.resetSystem.bind(this));
                document.getElementById('btn-reset-monetary').addEventListener('click', this.resetMonetaryData.bind(this));
                
                document.getElementById('btn-download-data').addEventListener('click', this.downloadBackup.bind(this));
                document.getElementById('btn-upload-data').addEventListener('click', this.loadBackup.bind(this));
                document.getElementById('upload-file-input').addEventListener('change', this.handleFileUpload.bind(this));

                window.addEventListener('resize', this.adjustAdaptiveText.bind(this));
            }
        }

        const app = new App();
        document.addEventListener('DOMContentLoaded', () => app.init());

        window.calcularCostoUnitario = function() {
            const precioCaja = parseFloat(document.getElementById('precioCaja').value) || 0;
            const unidadesCaja = parseInt(document.getElementById('unidadesCaja').value) || 0;
            const resultadoCosto = document.getElementById('resultadoCosto');

            if (precioCaja > 0 && unidadesCaja > 0) {
                const costoUnitario = precioCaja / unidadesCaja;
                document.getElementById('producto-costo').value = costoUnitario.toFixed(2);
                app.calculateProductPrices();
                resultadoCosto.textContent = `Costo Unitario Calculado: ${formatCurrency(costoUnitario)}`;
            } else {
                resultadoCosto.textContent = 'Ingrese valores válidos en ambos campos.';
            }
        };
    </script>
    
</body>
</html>